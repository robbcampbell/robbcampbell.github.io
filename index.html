e0 = osrmData?.routes?.[0];
      if (!route0) throw new Error("No route found");
      setRoute(route0.geometry);

      // 3) Sample towns along the route
      const samples = samplePolyline(route0.geometry.coordinates, 20000); // every 20 km
      const found = [];
      for (const c of samples) {
        const [lon, lat] = c;
        const rev = new URL("https://nominatim.openstreetmap.org/reverse");
        rev.searchParams.set("lat", String(lat));
        rev.searchParams.set("lon", String(lon));
        rev.searchParams.set("format", "jsonv2");
        rev.searchParams.set("zoom", "10"); // bias toward towns/cities
        const r = await fetch(rev, { headers: { "Accept-Language": "en" } });
        if (!r.ok) continue;
        const j = await r.json();
        const addr = j?.address || {};
        const name = addr.town || addr.city || addr.village || addr.hamlet;
        if (!name) continue;
        const state = addr.state || addr.region || "";
        const country = addr.country || "";
        found.push({
          key: `${name}, ${state}, ${country}`.trim(),
          name,
          displayName: `${name}${state ? ", " + state : ""}`,
          lat,
          lon,
        });
        await sleep(200); // rate limiting
      }
      const unique = dedupeByKey(found, (t) => t.key);

      // 4) Enrich with Wikipedia summaries
      const withWiki = [];
      for (const t of unique) {
        const searchUrl = new URL("https://en.wikipedia.org/w/api.php");
        searchUrl.searchParams.set("origin", "*");
        searchUrl.searchParams.set("action", "query");
        searchUrl.searchParams.set("list", "search");
        searchUrl.searchParams.set("srsearch", `${t.name}`);
        searchUrl.searchParams.set("format", "json");
        let pageTitle = null;
        try {
          const sr = await fetch(searchUrl);
          const sj = await sr.json();
          pageTitle = sj?.query?.search?.[0]?.title || null;
        } catch {}

        let summary = null;
        let excerpt = null;
        let url = null;
        if (pageTitle) {
          const sumUrl = new URL(
            `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(pageTitle)}`
          );
          try {
            const sres = await fetch(sumUrl);
            if (sres.ok) {
              const sj = await sres.json();
              summary = sj.extract;
              excerpt = sj.description || null;
              url = sj.content_urls?.desktop?.page || null;
            }
          } catch {}
        }
        withWiki.push({ ...t, wiki: { pageTitle, summary, excerpt, url } });
        await sleep(150);
      }

      setTowns(withWiki);
    } catch (e) {
      console.error(e);
      setError(e.message || "Something went wrong");
    } finally {
      setLoading(false);
    }
  }, [origin, destination, waypointsText, forwardGeocode]);

  const polyLatLngs = useMemo(
    () => (route ? coordsToLatLngs(route.coordinates) : []),
    [route, coordsToLatLngs]
  );

  return (
    <div className="min-h-screen w-full bg-neutral-50">
      <div className="max-w-6xl mx-auto p-4 md:p-6">
        <motion.h1
          initial={{ opacity: 0, y: -6 }}
          animate={{ opacity: 1, y: 0 }}
          className="text-3xl md:text-4xl font-bold tracking-tight"
        >
          Road Trip Facts Mapper
        </motion.h1>
        <p className="text-neutral-600 mt-1">Type your route, see it on the map, and discover bite-sized history for towns you pass through.</p>

        <div className="grid md:grid-cols-3 gap-4 mt-6 items-start">
          <Card className="md:col-span-1 shadow-sm rounded-2xl">
            <CardHeader className="pb-2">
              <CardTitle className="text-xl">Your Route</CardTitle>
            </CardHeader>
            <CardContent className="space-y-3">
              <div>
                <label className="text-sm font-medium">Origin</label>
                <Input placeholder="e.g., Dallas, TX" value={origin} onChange={(e) => setOrigin(e.target.value)} />
              </div>
              <div>
                <label className="text-sm font-medium">Destination</label>
                <Input placeholder="e.g., Denver, CO" value={destination} onChange={(e) => setDestination(e.target.value)} />
              </div>
              <div>
                <label className="text-sm font-medium">Waypoints (optional, one per line)</label>
                <Textarea rows={5} placeholder={"Amarillo, TX\nSanta Fe, NM"} value={waypointsText} onChange={(e) => setWaypointsText(e.target.value)} />
              </div>
              <div className="flex gap-2">
                <Button className="rounded-2xl" onClick={buildRoute} disabled={loading || !origin || !destination}>
                  {loading ? <Loader2 className="animate-spin mr-2 h-4 w-4"/> : <Search className="mr-2 h-4 w-4"/>}
                  Build route
                </Button>
                <Button variant="secondary" className="rounded-2xl" onClick={() => { setRoute(null); setTowns([]); setError(null); }}>
                  Clear
                </Button>
              </div>
              <div className="text-xs text-neutral-500">
                Uses OpenStreetMap (Nominatim + tiles), OSRM for routing, and Wikipedia for facts. Please be patient—APIs rate-limit.
              </div>
              {error && (
                <div className="text-sm text-red-600 bg-red-50 rounded-xl p-2">{error}</div>
              )}
            </CardContent>
          </Card>

          <div className="md:col-span-2 space-y-4">
            <Card className="overflow-hidden shadow-sm rounded-2xl">
              <CardHeader className="pb-2">
                <CardTitle className="text-xl flex items-center gap-2"><Route className="h-5 w-5"/> Map</CardTitle>
              </CardHeader>
              <CardContent className="p-0">
                <div className="h-[380px] w-full">
                  <MapContainer center={[37.5, -96]} zoom={4} className="h-full w-full rounded-b-2xl">
                    <TileLayer
                      attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                      url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
                    />
                    {route && (
                      <>
                        <FitToRoute geojson={route} />
                        <Polyline positions={polyLatLngs} weight={5} opacity={0.85} />
                        {/* Start and End markers */}
                        {polyLatLngs.length > 0 && (
                          <Marker position={polyLatLngs[0]}>
                            <Popup>Start</Popup>
                          </Marker>
                        )}
                        {polyLatLngs.length > 1 && (
                          <Marker position={polyLatLngs[polyLatLngs.length - 1]}>
                            <Popup>Destination</Popup>
                          </Marker>
                        )}
                      </>
                    )}
                  </MapContainer>
                </div>
              </CardContent>
            </Card>

            <Card className="shadow-sm rounded-2xl">
              <CardHeader className="pb-2">
                <CardTitle className="text-xl flex items-center gap-2"><Info className="h-5 w-5"/> Town Facts Along the Way</CardTitle>
              </CardHeader>
              <CardContent>
                {loading && (
                  <div className="flex items-center gap-2 text-neutral-600"><Loader2 className="animate-spin"/> Fetching towns and history…</div>
                )}
                {!loading && towns.length === 0 && (
                  <div className="text-neutral-600 text-sm">Enter a route and click <span className="font-semibold">Build route</span> to see the towns and their stories.</div>
                )}
                {towns.length > 0 && (
                  <Accordion type="single" collapsible className="w-full">
                    {towns.map((t, idx) => (
                      <AccordionItem key={t.key} value={`item-${idx}`}>
                        <AccordionTrigger>
                          <div className="flex items-center gap-2">
                            <MapPin className="h-4 w-4"/>
                            <span className="font-medium">{t.displayName}</span>
                            {t.wiki?.excerpt && (
                              <Badge variant="secondary" className="ml-2">{t.wiki.excerpt}</Badge>
                            )}
                          </div>
                        </AccordionTrigger>
                        <AccordionContent>
                          {t.wiki?.summary ? (
                            <div className="space-y-2">
                              <p className="text-sm leading-6">{t.wiki.summary}</p>
                              {t.wiki.url && (
                                <a href={t.wiki.url} target="_blank" rel="noreferrer" className="text-sm underline">Read more on Wikipedia</a>
                              )}
                            </div>
                          ) : (
                            <p className="text-sm text-neutral-600">No summary found. Try clicking through on Wikipedia after searching: <span className="font-mono">{t.name}</span>.</p>
                          )}
                        </AccordionContent>
                      </AccordionItem>
                    ))}
                  </Accordion>
                )}
              </CardContent>
            </Card>
          </div>
        </div>

        <div className="mt-6 text-xs text-neutral-500">
          <p>
            Notes: This demo calls public endpoints directly from your browser. Heavy use may hit rate limits. For production, add server-side caching and your own tiles/routing keys (e.g., self-hosted OSRM or OpenRouteService with an API key).
          </p>
        </div>
      </div>
    </div>
  );
}
