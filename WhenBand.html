<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Band Album Timeline â€” Compact + Grouping</title>
  <meta name="description" content="Plot album releases for multiple bands on one timeline. New: compact mode (covers only) and overlap grouping with expandable stacks." />
  <style>
    :root{ --bg:#0d1117; --ink:#e6edf3; --muted:#9fb0c2; --card:#111826; --line:rgba(255,255,255,.08); --brand:#7aa2ff; --brand2:#68d7c5; --radius:16px; --cover:96px }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 600px at -10% -20%, rgba(122,162,255,.10), transparent 60%),radial-gradient(900px 500px at 110% -10%, rgba(104,215,197,.08), transparent 60%),var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased}
    a{color:#a7c6ff;text-decoration:none}

    .wrap{min-height:100vh;display:flex;flex-direction:column}
    header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg, rgba(13,17,23,.85), rgba(13,17,23,.55) 60%, transparent);backdrop-filter:blur(8px)}
    .bar{max-width:1200px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:8px}
    .brand{font-weight:900}
    .pill{font-size:12px;color:#0b1322;background:linear-gradient(135deg,var(--brand2),#7df5de);padding:2px 10px;border-radius:999px}
    .spacer{flex:1}

    main{max-width:1200px;margin:8px auto;padding:12px}

    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .pad{padding:12px}
    .head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line)}
    .muted{color:var(--muted);font-size:12px}

    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input, select, button{width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:#0b1322;color:var(--ink)}
    .row{display:grid;grid-template-columns:1.1fr .6fr .6fr .6fr auto;gap:8px}
    @media (max-width: 880px){ .row{grid-template-columns:1fr 1fr 1fr;grid-auto-rows:auto} .row .wide{grid-column:1/-1} }
    .btn{font-weight:800;cursor:pointer}
    .btn-primary{background:linear-gradient(135deg,var(--brand),#5f89ff);border:none}
    .btn-ghost{background:transparent}

    .options{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px}
    @media (max-width:760px){ .options{grid-template-columns:1fr 1fr} }
    .switch{display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:12px;padding:8px 10px;background:#0b1322}
    .switch input{width:auto}

    .hstack{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#0b1322}
    .chip .dot{width:10px;height:10px;border-radius:50%}

    /* Timeline */
    .tl-wrap{overflow-x:auto; overflow-y:visible; border-top:1px solid var(--line)}
    .yearbar{position:sticky;top:0;background:#0b1322;border-bottom:1px solid var(--line);z-index:5}
    .yearline{position:relative;height:28px}
    .tick{position:absolute;top:0;height:28px;border-left:1px solid rgba(255,255,255,.14);padding-left:6px;line-height:28px;font-size:12px;color:var(--muted);transform:translateX(-50%)}

    .lanes{position:relative}
    .lane{position:relative;border-bottom:1px dashed rgba(255,255,255,.12);padding:22px 0;min-height:calc(var(--cover) + 56px)}
    .lane .label{position:absolute;left:0;top:0;display:flex;gap:8px;align-items:center;font-weight:800}
    .lane .label .dot{width:12px;height:12px;border-radius:50%}

    .content{position:relative;margin-left:140px;min-width:1400px}

    .album, .group{position:absolute;transform:translate(-50%,0);top:8px}
    .album{width:var(--cover)}
    .cover{width:var(--cover);height:var(--cover);border-radius:8px;border:1px solid var(--line);object-fit:cover;background:#0b1322}
    .tag{font-size:10px;color:#0b1322;background:linear-gradient(135deg,var(--brand2),#7df5de);padding:2px 6px;border-radius:999px;display:inline-block;margin-top:4px}
    .title{font-size:11px;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:calc(var(--cover) + 40px)}
    .compact .title{display:none}

    /* Group pile */
    .pile{position:relative;display:inline-block}
    .badge{position:absolute;right:4px;bottom:4px;background:#0b1322;color:var(--ink);border:1px solid var(--line);border-radius:999px;padding:2px 6px;font-size:10px}
    .group.open .stack{display:grid}
    .stack{display:none;grid-template-columns:repeat(4, var(--cover));gap:8px;margin-top:8px}

    .legend{padding:10px;border-top:1px solid var(--line)}

    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111826;border:1px solid var(--line);padding:10px 12px;border-radius:12px;z-index:40;box-shadow:0 12px 30px rgba(0,0,0,.4)}

    @media (max-width: 760px){ :root{ --cover:76px } .content{ margin-left:110px; min-width:1200px } .stack{grid-template-columns:repeat(3, var(--cover))} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="bar">
        <div class="brand">ðŸ“€ Band Album Timeline</div>
        <span class="pill" id="status">Idle</span>
        <div class="spacer"></div>
        <button class="btn btn-ghost" id="resetBtn">Clear all</button>
      </div>
    </header>

    <main>
      <div class="card">
        <div class="head"><strong>Add bands</strong><span class="muted">Data: MusicBrainz + Cover Art Archive</span></div>
        <div class="pad">
          <div class="row">
            <div class="wide">
              <label>Band/Artist name</label>
              <input id="artistInput" placeholder="e.g., Metallica, Radiohead, Taylor Swift"/>
            </div>
            <div>
              <label>Include</label>
              <select id="typeFilter">
                <option value="album">Albums only</option>
                <option value="album,ep">Albums + EPs</option>
                <option value="album,ep,single">Albums + EPs + Singles</option>
              </select>
            </div>
            <div>
              <label>Since year</label>
              <input id="sinceYear" type="number" min="1900" max="2100" placeholder="1960"/>
            </div>
            <div>
              <label>Until year</label>
              <input id="untilYear" type="number" min="1900" max="2100" placeholder="2025"/>
            </div>
            <div>
              <label>&nbsp;</label>
              <button class="btn btn-primary" id="addBtn">Add band</button>
            </div>
          </div>

          <div class="options">
            <label class="switch"><input type="checkbox" id="compactToggle"/> Compact mode (covers only)</label>
            <label class="switch">Group overlap (px) <input type="range" id="overlapRange" min="10" max="64" value="28"/></label>
            <label class="switch">Cover size <input type="range" id="coverRange" min="64" max="128" value="96"/></label>
          </div>

          <div style="height:8px"></div>
          <div id="picked" class="hstack"></div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="head"><strong>Timeline</strong><span class="muted">Scroll sideways â€¢ Tap a stack to expand</span></div>
        <div class="tl-wrap">
          <div class="yearbar"><div class="yearline" id="yearline"></div></div>
          <div class="lanes" id="lanes"></div>
        </div>
        <div class="legend muted">Covers & dates from community data; missing dates or art can happen. Click a cover to open MusicBrainz.</div>
      </div>
    </main>
  </div>

  <dialog id="pickDlg"><div class="dlg">
    <h3 style="margin:0 0 8px 0">Pick an artist</h3>
    <div id="pickList" class="results"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:10px"><button class="btn btn-ghost" id="pickCancel">Cancel</button></div>
  </div></dialog>

  <div class="toast" id="toast" style="display:none"></div>

  <script>
    const statusEl = document.getElementById('status');
    const artistInput = document.getElementById('artistInput');
    const typeFilter = document.getElementById('typeFilter');
    const sinceYearEl = document.getElementById('sinceYear');
    const untilYearEl = document.getElementById('untilYear');
    const addBtn = document.getElementById('addBtn');
    const lanesEl = document.getElementById('lanes');
    const yearlineEl = document.getElementById('yearline');
    const pickedEl = document.getElementById('picked');
    const resetBtn = document.getElementById('resetBtn');

    const compactToggle = document.getElementById('compactToggle');
    const overlapRange = document.getElementById('overlapRange');
    const coverRange = document.getElementById('coverRange');

    const pickDlg = document.getElementById('pickDlg');
    const pickList = document.getElementById('pickList');
    const pickCancel = document.getElementById('pickCancel');

    const toast = document.getElementById('toast');
    function showToast(msg){ toast.textContent = msg; toast.style.display='block'; clearTimeout(showToast._t); showToast._t=setTimeout(()=>toast.style.display='none',1600); }

    const palette = ['#7aa2ff','#68d7c5','#ffd166','#ef476f','#b97aff','#7aff86','#ffa3a3','#9ad1ff','#f1b8ff','#a3ffc7'];
    let nextColor = 0;

    const state = {
      bands: [], // {id, name, color, itemsRaw, items:[{id,title,date,year,mbid,cover,url,type,time}]}
      minDate: null,
      maxDate: null,
      width: 1600,
    };

    function isoToTime(iso){ if(!iso) return null; const parts = iso.split('-').map(n=>parseInt(n,10)); const y=parts[0]; const m=(parts[1]||1)-1; const d=parts[2]||1; return new Date(y,m,d).getTime(); }

    function filterByYears(items){
      const since = parseInt(sinceYearEl.value,10); const until = parseInt(untilYearEl.value,10);
      return items.filter(it=>{
        if(!it.year) return false; if(!isNaN(since) && it.year < since) return false; if(!isNaN(until) && it.year > until) return false; return true;
      });
    }

    function updateYearScale(){
      const all = state.bands.flatMap(b=>filterByYears(b.items));
      const years = all.map(x=>x.year).filter(Boolean);
      if(years.length===0){ yearlineEl.innerHTML=''; lanesEl.innerHTML=''; return; }
      const minY = Math.min(...years) - 1; const maxY = Math.max(...years) + 1;
      state.minDate = new Date(minY,0,1).getTime();
      state.maxDate = new Date(maxY,0,1).getTime();

      const containerWidth = Math.max(1400, (maxY - minY + 1) * 120); // 120px per year baseline
      state.width = containerWidth;
      yearlineEl.style.width = containerWidth + 'px';
      yearlineEl.innerHTML = '';

      for(let y=minY; y<=maxY; y++){
        const x = timeToX(new Date(y,0,1).getTime(), containerWidth);
        const tick = document.createElement('span');
        tick.className = 'tick';
        tick.style.left = x + 'px';
        tick.textContent = y;
        yearlineEl.appendChild(tick);
      }

      renderLanes();
    }

    function timeToX(t, width){ return state.minDate===null?0 : ((t - state.minDate) / (state.maxDate - state.minDate)) * width; }

    function clusterItems(items, width, threshold){
      // items: sorted by time; output clusters with average x
      const withX = items.map(it=>({ ...it, x: timeToX(it.time, width) })).sort((a,b)=>a.x-b.x);
      const clusters = []; let cur=null;
      for(const it of withX){
        if(!cur){ cur={x:it.x, items:[it]}; clusters.push(cur); continue; }
        const last = cur.items[cur.items.length-1];
        if(Math.abs(it.x - last.x) <= threshold){ cur.items.push(it); cur.x = cur.items.reduce((s,p)=>s+p.x,0)/cur.items.length; }
        else { cur={x:it.x, items:[it]}; clusters.push(cur); }
      }
      return clusters;
    }

    function renderLanes(){
      lanesEl.innerHTML = '';
      const compact = compactToggle.checked;
      document.body.classList.toggle('compact', compact);

      state.bands.forEach((band)=>{
        const lane = document.createElement('div'); lane.className='lane';
        const label = document.createElement('div'); label.className='label';
        const dot = document.createElement('span'); dot.className='dot'; dot.style.background = band.color; label.appendChild(dot);
        const name = document.createElement('span'); name.textContent = band.name; label.appendChild(name);
        const remove = document.createElement('button'); remove.className='btn btn-ghost'; remove.textContent='Remove'; remove.style.marginLeft='8px'; remove.onclick = ()=>{ state.bands = state.bands.filter(b=>b.id!==band.id); document.getElementById('chip-'+band.id)?.remove(); updateYearScale(); };
        label.appendChild(remove);
        lane.appendChild(label);

        const content = document.createElement('div'); content.className='content'; content.style.width = state.width+'px'; lane.appendChild(content);

        const items = filterByYears(band.items);
        const threshold = parseInt(overlapRange.value,10);
        const clusters = clusterItems(items, state.width, threshold);

        let maxBottom = 8 + parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cover')) + 24; // default cover height + padding

        clusters.forEach((cl, idx)=>{
          if(cl.items.length === 1){
            const it = cl.items[0];
            const el = document.createElement('a'); el.href = it.url; el.target='_blank'; el.rel='noreferrer'; el.className='album'; el.style.left = cl.x+'px'; el.title = `${it.title} â€” ${it.date||it.year}`;
            el.innerHTML = `<img class="cover" loading="lazy" src="${it.cover}" alt="${escapeHtml(it.title)}" onerror="this.src='https://placehold.co/300x300?text=No+Art'"/><div class="tag" style="background:${band.color}">${it.year}</div><div class="title">${escapeHtml(it.title)}</div>`;
            content.appendChild(el);
          } else {
            const g = document.createElement('div'); g.className='group'; g.style.left = cl.x+'px';
            const pile = document.createElement('div'); pile.className='pile';
            const lead = cl.items[0];
            pile.innerHTML = `<img class="cover" loading="lazy" src="${lead.cover}" alt="${escapeHtml(lead.title)}" onerror="this.src='https://placehold.co/300x300?text=No+Art'"/><span class='badge'>Ã—${cl.items.length}</span>`;
            g.appendChild(pile);

            const stack = document.createElement('div'); stack.className='stack';
            cl.items.forEach(it=>{
              const a = document.createElement('a'); a.href=it.url; a.target='_blank'; a.rel='noreferrer'; a.title = `${it.title} â€” ${it.date||it.year}`;
              a.innerHTML = `<img class='cover' loading='lazy' src='${it.cover}' alt='${escapeHtml(it.title)}' onerror="this.src='https://placehold.co/300x300?text=No+Art'"/>${compact?'' : `<div class='title'>${escapeHtml(it.title)}</div>`}`;
              stack.appendChild(a);
            });
            g.appendChild(stack);

            g.addEventListener('click', (e)=>{
              e.preventDefault(); e.stopPropagation();
              g.classList.toggle('open');
              // recompute lane height to fit expanded stacks
              requestAnimationFrame(()=>{
                const covers = g.querySelectorAll('.cover');
                const rect = g.getBoundingClientRect();
                const laneRect = lane.getBoundingClientRect();
                const bottom = (g.offsetTop + g.offsetHeight) + 24; // within lane
                maxBottom = Math.max(maxBottom, bottom);
                lane.style.minHeight = Math.ceil(maxBottom) + 'px';
              });
            });

            content.appendChild(g);
          }
        });

        // ensure lane is tall enough for any open groups
        lane.style.minHeight = Math.ceil(maxBottom) + 'px';
        lanesEl.appendChild(lane);
      });
    }

    function addChip(band){
      const chip = document.createElement('div'); chip.className='chip'; chip.id='chip-'+band.id;
      const dot = document.createElement('span'); dot.className='dot'; dot.style.background=band.color; chip.appendChild(dot);
      const name = document.createElement('span'); name.textContent = band.name; chip.appendChild(name);
      const x = document.createElement('button'); x.textContent='Ã—'; x.className='btn btn-ghost'; x.style.padding='4px 8px'; x.onclick=()=>{ state.bands=state.bands.filter(b=>b.id!==band.id); chip.remove(); updateYearScale(); };
      chip.appendChild(x); pickedEl.appendChild(chip);
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

    // ===== MusicBrainz helpers
    const MB_BASE = 'https://musicbrainz.org/ws/2';
    async function mbSearchArtist(q){
      const url = new URL(MB_BASE + '/artist'); url.searchParams.set('query', q); url.searchParams.set('fmt','json'); url.searchParams.set('limit','8');
      const res = await fetch(url, { headers: { 'Accept':'application/json' } }); if(!res.ok) throw new Error('Artist search failed');
      const j = await res.json(); return j.artists||[];
    }

    async function mbReleaseGroups(artistId){
      const url = new URL(MB_BASE + '/release-group'); url.searchParams.set('artist', artistId); url.searchParams.set('fmt','json'); url.searchParams.set('limit','200');
      const res = await fetch(url, { headers: { 'Accept':'application/json' } }); if(!res.ok) throw new Error('Release groups failed');
      const j = await res.json(); return j['release-groups']||[];
    }

    function coverUrlForReleaseGroup(mbid){
      return `https://coverartarchive.org/release-group/${mbid}/front-250`;
    }

    function normalizeItems(rgs, typeMask){
      const types = typeMask.split(',');
      const out = [];
      for(const rg of rgs){
        const primary = (rg['primary-type']||'').toLowerCase();
        if(primary && !types.includes(primary)) continue;
        const date = rg['first-release-date']||''; const time = isoToTime(date); const year = date? parseInt(date.slice(0,4),10) : null; if(!year) continue;
        const title = rg.title; const url = `https://musicbrainz.org/release-group/${rg.id}`;
        out.push({ id: rg.id, title, date, year, time, mbid: rg.id, cover: coverUrlForReleaseGroup(rg.id), url, type: primary });
      }
      out.sort((a,b)=> (a.time||0)-(b.time||0));
      return out;
    }

    async function addBandFlow(name){
      statusEl.textContent='Searchingâ€¦';
      const results = await mbSearchArtist(`artist:${name}`);
      if(results.length===0){ showToast('No artist found'); statusEl.textContent='Idle'; return; }
      const top = results[0]; const needPick = results.length>1 && (top.score<100);
      if(needPick){
        pickList.innerHTML = results.map(a=>{
          const life = [a['life-span']?.begin, a['life-span']?.end].filter(Boolean).join('â€“');
          const type=a.type||''; const area=a.area?.name||''; const dis = [type, area, life].filter(Boolean).join(' â€¢ ');
          return `<div class="pick" data-id="${a.id}" data-name="${escapeHtml(a.name)}" style="display:flex;gap:8px;align-items:center;padding:8px;border-radius:12px;border:1px solid var(--line);background:#0b1322;cursor:pointer"><div style="font-weight:800">${escapeHtml(a.name)}</div><div class="muted">${escapeHtml(dis)}</div></div>`;
        }).join('');
        pickDlg.showModal();
        const select = (e)=>{
          const el = e.target.closest('.pick'); if(!el) return; pickDlg.close(); pickList.removeEventListener('click', select);
          addBandById(el.dataset.id, el.dataset.name);
        };
        pickList.addEventListener('click', select);
        pickCancel.onclick = ()=>{ pickDlg.close(); pickList.removeEventListener('click', select); statusEl.textContent='Idle'; };
      } else {
        addBandById(top.id, top.name);
      }
    }

    async function addBandById(artistId, artistName){
      try{
        statusEl.textContent='Loading releasesâ€¦';
        const rgs = await mbReleaseGroups(artistId);
        const items = normalizeItems(rgs, typeFilter.value);
        if(items.length===0){ showToast('No releases matched filters'); statusEl.textContent='Idle'; return; }
        const color = palette[nextColor++ % palette.length];
        const band = { id: artistId, name: artistName, color, itemsRaw: rgs, items };
        state.bands.push(band);
        addChip(band);
        updateYearScale();
        statusEl.textContent='Done';
      }catch(e){ console.error(e); showToast(e.message||'Failed to load'); statusEl.textContent='Error'; }
    }

    function reapplyFilters(){
      state.bands = state.bands.map(b=>({ ...b, items: normalizeItems(b.itemsRaw, typeFilter.value) }));
      updateYearScale();
    }

    // ===== Events
    addBtn.onclick = ()=>{ const name = artistInput.value.trim(); if(!name) return showToast('Enter a band/artist name'); addBandFlow(name); };
    artistInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ addBtn.click(); }});
    typeFilter.onchange = ()=> reapplyFilters();
    sinceYearEl.addEventListener('input', updateYearScale);
    untilYearEl.addEventListener('input', updateYearScale);
    compactToggle.addEventListener('change', renderLanes);
    overlapRange.addEventListener('input', renderLanes);
    coverRange.addEventListener('input', ()=>{ document.documentElement.style.setProperty('--cover', coverRange.value + 'px'); renderLanes(); });
    resetBtn.onclick = ()=>{ state.bands=[]; pickedEl.innerHTML=''; yearlineEl.innerHTML=''; lanesEl.innerHTML=''; statusEl.textContent='Idle'; };

    // Resize handler to recompute widths
    window.addEventListener('resize', ()=>{ if(state.minDate!==null){ updateYearScale(); } });
  </script>
</body>
</html>
