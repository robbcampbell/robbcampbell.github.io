<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Custom Work Schedule → PDF (Canvas) & iPhone Calendar</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
  :root{ --bg:#0b1020; --muted:#99a2c2; --text:#e9edff; --ring:rgba(110,168,254,.35); }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 800px at 80% -10%, #1f2b55, transparent), var(--bg);
       color:var(--text);font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif}
  .wrap{max-width:980px;margin:0 auto;padding:20px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  h1{font-size:clamp(1.25rem,2.4vw,1.8rem);margin:0;font-weight:700;letter-spacing:.2px}
  .card{background:linear-gradient(180deg,#162044,#121a37);border:1px solid rgba(255,255,255,.06);
        border-radius:16px;padding:16px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
  .grid{display:grid;gap:12px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  @media (max-width:720px){.grid.cols-2{grid-template-columns:1fr}}
  label{display:block;font-size:.9rem;color:var(--muted);margin:2px 0 6px}
  input, select{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.08);
                background:#0e1530;color:var(--text);outline:none}
  input:focus, select:focus{border-color:#6ea8fe;box-shadow:0 0 0 6px var(--ring)}
  .row{display:flex;gap:10px;align-items:end}
  .row>*{flex:1}
  .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;color:var(--text);
       background:linear-gradient(180deg,#3a66ff,#274ce0);font-weight:600;cursor:pointer}
  .btn.secondary{background:linear-gradient(180deg,#22c1a7,#1aa68c)}
  .btn.ghost{background:#11193a;border:1px solid rgba(255,255,255,.12)}
  .btn.small{padding:8px 10px;border-radius:10px;font-size:.9rem}
  .btn-row{display:flex;gap:10px;flex-wrap:wrap}
  .tag{padding:6px 10px;border-radius:999px;background:#101633;border:1px solid rgba(255,255,255,.08);color:var(--muted);font-size:.85rem}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  td,th{padding:8px 10px;text-align:left}
  .pat-row{background:#0f1634;border:1px solid rgba(255,255,255,.06);border-radius:12px}
  .pat-row td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
  .pat-row td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
  .hint{color:var(--muted);font-size:.85rem}
  .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.15),transparent);margin:14px 0}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#0f1735;border:1px solid rgba(255,255,255,.1)}
  .legend{display:flex;gap:10px;flex-wrap:wrap}
  .swatch{width:14px;height:14px;border-radius:3px;border:1px solid rgba(255,255,255,.25)}
  canvas{display:none}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Custom Work Schedule → PDF (Canvas) & iPhone Calendar</h1>
      <span class="tag">Mobile-ready • Offline • Private</span>
    </header>

    <div class="card" style="margin-top:14px">
      <div class="grid cols-2">
        <div>
          <label for="startDT">Start date & time</label>
          <input id="startDT" type="datetime-local" />
        </div>
        <div>
          <label for="endDT">End date (inclusive)</label>
          <input id="endDT" type="date" />
        </div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <div style="flex:2">
          <label>Shift pattern (sequence repeats)</label>
          <div class="hint">Add rows like: <em>Work, 24 hours</em> → <em>Off, 72 hours</em> → …</div>
        </div>
        <div style="flex:1;text-align:right">
          <button class="btn small ghost" id="addRow">+ Add row</button>
        </div>
      </div>

      <table id="patternTable">
        <thead>
          <tr><th>Label</th><th>Hours</th><th></th></tr>
        </thead>
        <tbody id="patternBody"></tbody>
      </table>

      <div class="grid cols-2" style="margin-top:6px">
        <div>
          <label for="workColor">Work color</label>
          <input id="workColor" type="color" value="#97d897" />
        </div>
        <div>
          <label for="offColor">Off color</label>
          <input id="offColor" type="color" value="#d6d6d6" />
        </div>
      </div>

      <div class="divider"></div>

      <div class="grid cols-2">
        <div>
          <label for="weekStart">Week starts on</label>
          <select id="weekStart">
            <option value="mon" selected>Monday</option>
            <option value="sun">Sunday</option>
          </select>
        </div>
        <div>
          <label for="icsMode">iPhone Calendar events</label>
          <select id="icsMode">
            <option value="allday" selected>All-day (Work/Off per day)</option>
            <option value="timed">Timed (exact start/end of each period)</option>
          </select>
        </div>
      </div>

      <div style="margin-top:12px" class="legend">
        <span class="pill"><span class="swatch" id="swWork" style="background:#97d897"></span> Work</span>
        <span class="pill"><span class="swatch" id="swOff"  style="background:#d6d6d6"></span> Off</span>
      </div>

      <div class="divider"></div>

      <div class="btn-row">
        <button class="btn" id="genPdf">Generate PDF</button>
        <button class="btn secondary" id="genIcs">Add to iPhone Calendar (.ics)</button>
        <button class="btn ghost" id="fillExample">Fill example (24W/72O/48W/72O)</button>
      </div>

      <div style="margin-top:10px" class="hint">
        If you were seeing blank fills before, this version rasterizes months to PNG images first — colors will show in Safari/Files/Books.
      </div>
    </div>
  </div>

<script>
(() => {
  const { jsPDF } = window.jspdf;

  // ---------- UI ----------
  const $ = (id) => document.getElementById(id);
  const patternBody = $("patternBody");

  function addPatternRow(label="Work", hours=24){
    const tr = document.createElement("tr");
    tr.className = "pat-row";
    tr.innerHTML = `
      <td><input type="text" value="${label}" placeholder="Work / Off / etc." /></td>
      <td><input type="number" min="1" step="1" value="${hours}" /></td>
      <td style="width:1%"><button class="btn small ghost remove">Delete</button></td>`;
    patternBody.appendChild(tr);
    tr.querySelector(".remove").addEventListener("click", () => tr.remove());
  }
  $("addRow").addEventListener("click", () => addPatternRow("Work", 24));
  $("fillExample").addEventListener("click", () => {
    patternBody.innerHTML = "";
    addPatternRow("Work", 24);
    addPatternRow("Off", 72);
    addPatternRow("Work", 48);
    addPatternRow("Off", 72);
    if (!$("startDT").value) $("startDT").value = "2025-11-04T07:00";
    if (!$("endDT").value) $("endDT").value = "2026-12-31";
  });
  if (!patternBody.children.length) addPatternRow("Work", 24);
  $("workColor").addEventListener("input", e => $("swWork").style.background = e.target.value);
  $("offColor").addEventListener("input", e => $("swOff").style.background = e.target.value);

  // ---------- Dates & schedule ----------
  const MS_PER_HOUR = 3600 * 1000, MS_PER_DAY = 24 * MS_PER_HOUR;
  function toUTCFromLocalDateTimeLocal(s){ const d=new Date(s); if(isNaN(d)) return null;
    return Date.UTC(d.getFullYear(),d.getMonth(),d.getDate(),d.getHours(),d.getMinutes(),0); }
  function toUTCFromDateOnly(s){ const d=new Date(s+"T00:00:00"); if(isNaN(d)) return null;
    return Date.UTC(d.getFullYear(),d.getMonth(),d.getDate(),0,0,0); }
  const addHoursUTC=(ms,h)=>ms+h*MS_PER_HOUR, addDaysUTC=(ms,d)=>ms+d*MS_PER_DAY;
  function ymd(ms){ const d=new Date(ms); const y=d.getUTCFullYear(), m=d.getUTCMonth()+1, day=d.getUTCDate();
    return `${y}-${String(m).padStart(2,"0")}-${String(day).padStart(2,"0")}`; }
  function monthSpan(startUtc, endUtcInclusive){
    const out=[]; let y=new Date(startUtc).getUTCFullYear(), m0=new Date(startUtc).getUTCMonth();
    const ey=new Date(endUtcInclusive).getUTCFullYear(), em0=new Date(endUtcInclusive).getUTCMonth();
    while(y<ey || (y===ey && m0<=em0)){ out.push({y,m0}); m0++; if(m0>11){m0=0;y++;} }
    return out;
  }
  function readPattern(){
    const rows=[...patternBody.querySelectorAll("tr")].map(tr=>{
      const [lEl,hEl]=tr.querySelectorAll("input");
      const label=(lEl.value||"Work").trim();
      const hours=Math.max(1, parseInt(hEl.value||"1",10));
      return [label,hours];
    });
    if(!rows.length) throw new Error("Please add at least one pattern row.");
    return rows;
  }
  function buildSchedule({startUtc, endUtcExclusive, pattern}){
    const scheduleByDay=new Map(), periods=[];
    let current=startUtc, pIndex=0;
    while(current<endUtcExclusive){
      const [label,hours]=pattern[pIndex];
      const periodEnd=addHoursUTC(current,hours);
      periods.push({label,startUtc:current,endUtc:Math.min(periodEnd,endUtcExclusive)});
      let iter=current;
      while(iter<periodEnd && iter<endUtcExclusive){
        scheduleByDay.set(ymd(iter), label);
        iter=addDaysUTC(iter,1);
      }
      current=periodEnd; pIndex=(pIndex+1)%pattern.length;
    }
    return {scheduleByDay, periods};
  }

  // ---------- Canvas month renderer ----------
  // Canvas will be 2200x1700 to keep things crisp; then downscale to PDF page.
  function drawMonthToCanvas({y, m0, scheduleByDay, weekStart, workColor, offColor}){
    const width = 2200, height = 1700;
    const canvas = document.createElement("canvas");
    canvas.width = width; canvas.height = height;
    const ctx = canvas.getContext("2d");
    // Background
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,width,height);

    // Layout
    const margin = 90, headerH = 120, dayHeaderH = 60;
    const cols = 7, rows = 6;
    const cellW = (width - margin*2) / cols;
    const cellH = (height - margin*2 - headerH - dayHeaderH) / rows;

    // Fonts
    ctx.font = "bold 48px Inter, Arial, sans-serif";
    ctx.fillStyle = "#1b1b1b";
    ctx.textAlign = "center"; ctx.textBaseline = "top";
    const monthName = new Date(Date.UTC(y, m0, 1)).toLocaleString("en-US", { month: "long", timeZone: "UTC" });
    ctx.fillText(`${monthName} ${y}`, width/2, margin - 10);

    // Day headers
    const dayNamesMon = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
    const dayNamesSun = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    const dayNames = weekStart==="sun"? dayNamesSun : dayNamesMon;
    ctx.font = "400 32px Inter, Arial, sans-serif";
    ctx.textBaseline = "alphabetic";
    for (let i=0; i<7; i++){
      const x = margin + i*cellW + cellW/2;
      const yText = margin + headerH;
      ctx.fillStyle = "#2b2b2b";
      ctx.fillText(dayNames[i], x, yText);
    }

    // Month geometry
    const firstUTC = Date.UTC(y, m0, 1);
    const firstDayJS = new Date(firstUTC).getUTCDay(); // Sun=0..6
    const toWeekIndex = (sun0)=> weekStart==="sun" ? sun0 : (sun0+6)%7;
    const firstDow = toWeekIndex(firstDayJS);
    const daysInMonth = new Date(Date.UTC(y, m0+1, 0)).getUTCDate();

    // Colors
    const gridStroke = "#4a4a4a";
    const work = workColor; const off = offColor;

    // Cells
    let dayNum = 1;
    ctx.textAlign = "left";
    for (let r=0; r<rows; r++){
      for (let c=0; c<cols; c++){
        const x = Math.round(margin + c*cellW);
        const yCell = Math.round(margin + headerH + dayHeaderH + r*cellH);
        const w = Math.floor(cellW), h = Math.floor(cellH);

        // border
        ctx.strokeStyle = gridStroke;
        ctx.lineWidth = 2;

        const index = r*7 + c;
        if (index >= firstDow && dayNum <= daysInMonth){
          const dateUTC = Date.UTC(y, m0, dayNum);
          const key = ymd(dateUTC);
          const label = (scheduleByDay.get(key) || "").trim();

          // fill
          if (label){
            ctx.fillStyle = (label.toLowerCase()==="work") ? work : off;
            ctx.fillRect(x, yCell, w, h);
          } else {
            ctx.fillStyle = "#ffffff";
            ctx.fillRect(x, yCell, w, h);
          }

          // border
          ctx.strokeRect(x, yCell, w, h);

          // day number
          ctx.fillStyle = "#111";
          ctx.font = "bold 28px Inter, Arial, sans-serif";
          ctx.textBaseline = "top";
          ctx.fillText(String(dayNum), x+10, yCell+8);

          // label
          if (label){
            ctx.fillStyle = "#111";
            ctx.font = "500 30px Inter, Arial, sans-serif";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(label, x + w/2, yCell + h/2);
            ctx.textAlign = "left";
          }

          dayNum++;
        } else {
          // out of month cell
          ctx.fillStyle = "#ffffff";
          ctx.fillRect(x, yCell, w, h);
          ctx.strokeRect(x, yCell, w, h);
        }
      }
    }

    // Legend
    const legendY = height - margin + 20;
    function legendBox(lx, label, color){
      ctx.fillStyle = color; ctx.strokeStyle = gridStroke; ctx.lineWidth = 2;
      ctx.fillRect(lx, legendY-28, 24, 24); ctx.strokeRect(lx, legendY-28, 24, 24);
      ctx.fillStyle = "#222"; ctx.font = "400 28px Inter, Arial, sans-serif"; ctx.textBaseline = "alphabetic";
      ctx.textAlign = "left"; ctx.fillText(label, lx + 34, legendY - 6);
    }
    legendBox(margin, "Work", work);
    legendBox(margin + 180, "Off", off);

    return canvas;
  }

  // ---------- PDF via canvas images ----------
  async function makePdfViaCanvas({scheduleByDay, startUtc, endUtcInclusive, workColor, offColor, weekStart}){
    const doc = new jsPDF({ orientation: "landscape", unit: "pt", format: "letter", compress: true });
    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();

    const months = monthSpan(startUtc, endUtcInclusive);
    months.forEach(({y,m0}, idx) => {
      if (idx > 0) doc.addPage("letter", "landscape");
      const canvas = drawMonthToCanvas({ y, m0, scheduleByDay, weekStart, workColor, offColor });
      const dataUrl = canvas.toDataURL("image/png"); // opaque PNG; iOS-safe
      doc.addImage(dataUrl, "PNG", 0, 0, pageW, pageH);
    });

    const fname = `Work_Schedule_${ymd(startUtc)}_to_${ymd(endUtcInclusive)}.pdf`;
    doc.save(fname);
  }

  // ---------- ICS ----------
  function downloadIcs({scheduleByDay, periods, startUtc, endUtcInclusive, mode}){
    const NL="\r\n", now=new Date(), dtstamp=toICSDateTimeUTC(now);
    let ics="BEGIN:VCALENDAR"+NL+"VERSION:2.0"+NL+"PRODID:-//Custom Work Schedule//EN"+NL+"CALSCALE:GREGORIAN"+NL+"METHOD:PUBLISH"+NL;
    if(mode==="allday"){
      const startDay=Date.UTC(new Date(startUtc).getUTCFullYear(), new Date(startUtc).getUTCMonth(), new Date(startUtc).getUTCDate());
      const endDay=Date.UTC(new Date(endUtcInclusive).getUTCFullYear(), new Date(endUtcInclusive).getUTCMonth(), new Date(endUtcInclusive).getUTCDate());
      for(let d=startDay; d<=endDay; d+=MS_PER_DAY){
        const label=scheduleByDay.get(ymd(d)); if(!label) continue;
        const dt=new Date(d); const y=dt.getUTCFullYear(), m=dt.getUTCMonth(), day=dt.getUTCDate();
        const dtStart=toICSDateOnly(y,m,day); const next=new Date(Date.UTC(y,m,day+1));
        const dtEnd=toICSDateOnly(next.getUTCFullYear(), next.getUTCMonth(), next.getUTCDate());
        const uid=`allday-${y}${m+1}${day}-${Math.random().toString(36).slice(2)}@custom-schedule`;
        ics+="BEGIN:VEVENT"+NL+`UID:${uid}`+NL+`DTSTAMP:${dtstamp}`+NL+`SUMMARY:${escapeICSText(label)}`+NL+
             `DTSTART;VALUE=DATE:${dtStart}`+NL+`DTEND;VALUE=DATE:${dtEnd}`+NL+"END:VEVENT"+NL;
      }
    } else {
      for(const p of periods){
        if(p.endUtc<=startUtc || p.startUtc>endUtcInclusive) continue;
        const s=Math.max(p.startUtc,startUtc), e=Math.min(p.endUtc,endUtcInclusive+MS_PER_DAY);
        const uid=`timed-${s}-${Math.random().toString(36).slice(2)}@custom-schedule`;
        ics+="BEGIN:VEVENT"+NL+`UID:${uid}`+NL+`DTSTAMP:${dtstamp}`+NL+`SUMMARY:${escapeICSText(p.label)}`+NL+
             `DTSTART:${toICSDateTimeUTC(new Date(s))}`+NL+`DTEND:${toICSDateTimeUTC(new Date(e))}`+NL+"END:VEVENT"+NL;
      }
    }
    ics+="END:VCALENDAR"+NL;
    const blob=new Blob([ics],{type:"text/calendar;charset=utf-8"});
    const a=document.createElement("a");
    a.download=`Work_Schedule_${ymd(startUtc).replaceAll("-","")}_to_${ymd(endUtcInclusive).replaceAll("-","")}.ics`;
    a.href=URL.createObjectURL(blob); document.body.appendChild(a); a.click();
    URL.revokeObjectURL(a.href); a.remove();
  }
  function toICSDateTimeUTC(d){ const y=d.getUTCFullYear(), m=String(d.getUTCMonth()+1).padStart(2,"0"),
    day=String(d.getUTCDate()).padStart(2,"0"), hh=String(d.getUTCHours()).padStart(2,"0"),
    mm=String(d.getUTCMinutes()).padStart(2,"0"), ss=String(d.getUTCSeconds()).padStart(2,"0");
    return `${y}${m}${day}T${hh}${mm}${ss}Z`; }
  function toICSDateOnly(y,m0,d){ return `${y}${String(m0+1).padStart(2,"0")}${String(d).padStart(2,"0")}`; }
  function escapeICSText(s){ return String(s).replace(/\\/g,"\\\\").replace(/;/g,"\\;").replace(/,/g,"\\,").replace(/\n/g,"\\n"); }

  // ---------- Actions ----------
  function gatherInputs(){
    const startDT=$("startDT").value, endD=$("endDT").value;
    if(!startDT) throw new Error("Please choose a start date & time.");
    if(!endD) throw new Error("Please choose an end date.");
    const startUtc=toUTCFromLocalDateTimeLocal(startDT);
    const endUtcInclusive=toUTCFromDateOnly(endD);
    if(startUtc==null || endUtcInclusive==null) throw new Error("Invalid dates.");
    if(endUtcInclusive<startUtc) throw new Error("End date must be on or after start date.");
    const pattern=readPattern();
    return { startUtc, endUtcInclusive, pattern,
             workColor:$("workColor").value, offColor:$("offColor").value,
             weekStart:$("weekStart").value, icsMode:$("icsMode").value };
  }

  $("genPdf").addEventListener("click", async ()=>{
    try{
      const { startUtc, endUtcInclusive, pattern, workColor, offColor, weekStart } = gatherInputs();
      const { scheduleByDay } = buildSchedule({ startUtc, endUtcExclusive: (endUtcInclusive + MS_PER_DAY), pattern });
      await makePdfViaCanvas({ scheduleByDay, startUtc, endUtcInclusive, workColor, offColor, weekStart });
    }catch(e){ alert(e.message||String(e)); }
  });

  $("genIcs").addEventListener("click", ()=>{
    try{
      const { startUtc, endUtcInclusive, pattern, icsMode } = gatherInputs();
      const built = buildSchedule({ startUtc, endUtcExclusive: (endUtcInclusive + MS_PER_DAY), pattern });
      downloadIcs({ ...built, startUtc, endUtcInclusive, mode: icsMode });
    }catch(e){ alert(e.message||String(e)); }
  });

  // Prefill example on first load
  if(!$("startDT").value && !$("endDT").value){ $("fillExample").click(); }
})();
</script>
</body>
</html>
