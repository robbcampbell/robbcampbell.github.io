<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<title>Fry Day â€” Picnic Panic</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Fredoka+One&family=Nunito:wght@400;700&family=MedievalSharp&display=swap" rel="stylesheet"/>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{width:100%;height:100%;overflow:hidden;background:#0a0500;font-family:'Nunito',sans-serif;touch-action:none;}

#shell{display:flex;flex-direction:column;width:100%;height:100%;align-items:center;justify-content:center;}
#wrapper{
  position:relative;
  width:min(100vw,900px);
  height:min(calc(100vh - 58px),calc(min(100vw,900px)*640/900));
  flex-shrink:0;border-radius:8px 8px 0 0;overflow:hidden;
  box-shadow:0 0 55px rgba(255,140,0,0.3),0 0 0 2px #5a3000;
}
canvas{display:block;width:100%;height:100%;}

/* â”€â”€ ctrl bar â”€â”€ */
#ctrl-bar{
  width:min(100vw,900px);background:#0a0400;
  border:2px solid #3a1a00;border-top:none;border-radius:0 0 8px 8px;
  display:none;flex-direction:row;align-items:center;justify-content:space-between;
  padding:6px 14px;gap:8px;box-shadow:0 4px 18px rgba(0,0,0,0.6);flex-shrink:0;
}
#ctrl-bar.visible{display:flex;}
#fhwrap-bar{display:flex;flex-direction:column;align-items:center;gap:1px;flex:1;min-width:0;}
#fhlabel{font-family:'Fredoka One',sans-serif;font-size:9px;color:rgba(255,180,80,0.6);letter-spacing:2px;}
#fhbg{width:100%;height:9px;background:rgba(0,0,0,0.5);border-radius:5px;border:1px solid rgba(255,110,30,0.28);overflow:hidden;}
#fhbar{height:100%;width:100%;background:linear-gradient(90deg,#44ff66,#aaff44);border-radius:5px;transition:width .2s,background .3s;}
.mob-btn{font-family:'Fredoka One',sans-serif;font-size:13px;padding:8px 14px;border-radius:20px;border:none;box-shadow:0 3px 0 rgba(0,0,0,0.5);-webkit-user-select:none;user-select:none;touch-action:manipulation;flex-shrink:0;}
.mob-btn.decoy-btn{background:#e8a800;color:#2a0e00;}
.mob-btn.focus-btn{background:#cc3300;color:#fff;}
.mob-btn.talent-btn{background:#4a2288;color:#ddc8ff;}

/* â”€â”€ HUD â”€â”€ */
#hud{position:absolute;top:0;left:0;right:0;display:flex;justify-content:space-between;align-items:center;padding:5px 8px;background:linear-gradient(to bottom,rgba(8,3,0,0.92),transparent);pointer-events:none;z-index:5;}
.hpill{background:rgba(8,3,0,0.75);border:1px solid rgba(255,160,30,0.25);border-radius:18px;padding:3px 10px;}
.hlabel{font-family:'Fredoka One',sans-serif;font-size:8px;color:rgba(255,200,100,0.45);letter-spacing:1px;text-transform:uppercase;}
.hval{font-family:'Fredoka One',sans-serif;font-size:18px;color:#ffcc44;line-height:1.1;}
.hval.purple{color:#cc88ff;}

/* Pause btn */
#pause-btn{
  position:absolute;top:7px;right:8px;
  background:rgba(60,20,100,0.85);border:1px solid rgba(180,100,255,0.4);
  border-radius:18px;padding:4px 14px;
  font-family:'Fredoka One',sans-serif;font-size:14px;color:#cc88ff;
  cursor:pointer;z-index:6;pointer-events:auto;
  transition:background .15s;letter-spacing:1px;
}
#pause-btn:hover{background:rgba(100,40,180,0.9);}

/* â”€â”€ Desktop health bar â”€â”€ */
#fhwrap{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;gap:2px;pointer-events:none;z-index:5;}
#fhlabel2{font-family:'Fredoka One',sans-serif;font-size:9px;color:rgba(255,180,80,0.55);letter-spacing:2px;}
#fhbg2{width:200px;height:10px;background:rgba(0,0,0,0.5);border-radius:5px;border:1px solid rgba(255,110,30,0.22);overflow:hidden;}
#fhbar2{height:100%;width:100%;background:linear-gradient(90deg,#44ff66,#aaff44);border-radius:5px;transition:width .2s,background .3s;}

/* â”€â”€ Banners â”€â”€ */
#pwrup-banner{position:absolute;top:50px;left:50%;transform:translateX(-50%);font-family:'Fredoka One',sans-serif;font-size:15px;letter-spacing:2px;background:rgba(0,0,0,0.7);border-radius:20px;padding:4px 14px;pointer-events:none;z-index:6;opacity:0;transition:opacity .3s;white-space:nowrap;}
#pwrup-banner.show{opacity:1;}
#decoy-ui{position:absolute;top:46px;right:48px;pointer-events:none;z-index:6;display:flex;flex-direction:column;align-items:flex-end;gap:2px;}
#decoy-count{font-family:'Fredoka One',sans-serif;font-size:12px;color:#ffcc44;background:rgba(0,0,0,0.6);border-radius:12px;padding:2px 10px;}
#decoy-hint{font-family:'Nunito',sans-serif;font-size:8px;color:rgba(255,200,100,0.45);letter-spacing:1px;text-align:right;}
#wave-text{position:absolute;left:50%;top:36%;transform:translate(-50%,-50%);font-family:'Fredoka One',sans-serif;font-size:clamp(32px,6vw,54px);color:#ff8822;text-shadow:0 0 22px rgba(255,130,0,0.9);pointer-events:none;z-index:10;opacity:0;transition:opacity .2s;white-space:nowrap;}
#wave-text.show{opacity:1;}
#bite-flash{position:absolute;inset:0;pointer-events:none;z-index:9;background:radial-gradient(ellipse at 50% 50%,rgba(255,0,0,0.28) 0%,transparent 65%);opacity:0;transition:opacity .15s;}
#bite-flash.show{opacity:1;}

/* â”€â”€ SCREENS â”€â”€ */
.screen{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:11px;z-index:20;background:rgba(8,3,0,0.93);backdrop-filter:blur(5px);}
.screen.hidden{display:none;}
.stitle{font-family:'Fredoka One',sans-serif;font-size:clamp(40px,7vw,68px);letter-spacing:3px;color:#ffcc44;line-height:1;text-shadow:0 0 28px rgba(255,140,0,0.8),0 4px 0 #6a3000;text-align:center;}
.stitle.red{color:#ff5522;text-shadow:0 0 26px rgba(255,50,0,0.9),0 4px 0 #5a1000;}
.stitle.purple{color:#cc88ff;text-shadow:0 0 26px rgba(180,80,255,0.8),0 4px 0 #3a0066;}
.ssub{font-family:'Fredoka One',sans-serif;font-size:clamp(12px,2.5vw,16px);color:rgba(255,200,100,0.6);letter-spacing:2px;text-transform:uppercase;text-align:center;}
.sdiv{width:160px;height:2px;background:linear-gradient(90deg,transparent,#ff8822,transparent);margin:2px 0;}
.howgrid{display:grid;grid-template-columns:1fr 1fr;gap:5px 16px;font-family:'Nunito',sans-serif;font-size:clamp(11px,2.2vw,14px);color:rgba(255,210,130,0.78);letter-spacing:.3px;max-width:420px;padding:0 10px;}
.howgrid strong{color:#ffcc44;}
.srow{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;}
.sbox{background:rgba(255,110,0,0.1);border:1px solid rgba(255,110,0,0.22);border-radius:10px;padding:9px 14px;text-align:center;}
.sbox-l{font-family:'Fredoka One',sans-serif;font-size:8px;color:rgba(255,200,100,0.4);letter-spacing:2px;text-transform:uppercase;margin-bottom:2px;}
.sbox-v{font-family:'Fredoka One',sans-serif;font-size:36px;color:#ffcc44;line-height:1;}
.btn{font-family:'Fredoka One',sans-serif;font-size:clamp(16px,3.5vw,24px);letter-spacing:3px;padding:10px 32px;background:#cc4400;color:#fff6e0;border:none;border-radius:8px;cursor:pointer;box-shadow:0 4px 0 #7a2200,0 6px 18px rgba(200,60,0,.4);transition:transform .1s,box-shadow .1s;text-transform:uppercase;touch-action:manipulation;}
.btn:hover{transform:translateY(-2px);box-shadow:0 6px 0 #7a2200,0 8px 26px rgba(200,60,0,.6);}
.btn:active{transform:translateY(2px);box-shadow:0 2px 0 #7a2200;}
.btn.purple{background:#6622cc;box-shadow:0 4px 0 #3a0088,0 6px 18px rgba(130,50,220,.4);}
.btn.purple:hover{box-shadow:0 6px 0 #3a0088,0 8px 26px rgba(130,50,220,.6);}
body.decoy-mode{cursor:crosshair;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TALENT TREE OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#talent-overlay{
  position:absolute;inset:0;z-index:25;
  background:rgba(4,1,12,0.96);
  backdrop-filter:blur(6px);
  display:flex;flex-direction:column;
  align-items:center;
  overflow-y:auto;
  overflow-x:hidden;
  padding:10px 10px 20px;
}
#talent-overlay.hidden{display:none;}

.talent-header{
  display:flex;justify-content:space-between;align-items:center;
  width:100%;max-width:860px;padding:0 4px 8px;flex-shrink:0;
}
.talent-title{
  font-family:'Fredoka One',sans-serif;font-size:clamp(20px,4vw,32px);
  color:#cc88ff;letter-spacing:3px;text-shadow:0 0 18px rgba(180,80,255,0.6);
}
.talent-currency{
  font-family:'Fredoka One',sans-serif;font-size:clamp(14px,2.5vw,20px);
  color:#ffcc44;background:rgba(0,0,0,0.5);border-radius:14px;padding:4px 14px;
  border:1px solid rgba(255,180,0,0.3);
}
.talent-close{
  font-family:'Fredoka One',sans-serif;font-size:16px;letter-spacing:2px;
  padding:6px 18px;background:#661100;color:#ffccaa;
  border:none;border-radius:10px;cursor:pointer;
  box-shadow:0 3px 0 #3a0800;touch-action:manipulation;
}
.talent-close:hover{background:#882200;}

/* Three columns: one per tree */
.talent-trees{
  display:flex;gap:10px;width:100%;max-width:880px;
  justify-content:center;flex-wrap:wrap;
}
.talent-tree{
  flex:1;min-width:220px;max-width:280px;
  background:rgba(10,4,24,0.7);border:1px solid rgba(180,80,255,0.15);
  border-radius:10px;padding:10px 8px;
  display:flex;flex-direction:column;gap:6px;
}
.tree-name{
  font-family:'Fredoka One',sans-serif;font-size:clamp(13px,2vw,16px);
  text-align:center;letter-spacing:2px;padding:4px 0 6px;
  border-bottom:1px solid rgba(255,255,255,0.08);margin-bottom:2px;
}
.tree-name.fire{color:#ff8833;}
.tree-name.sniper{color:#44ccff;}
.tree-name.chaos{color:#cc44ff;}

/* Talent node */
.tnode{
  position:relative;
  background:rgba(15,6,30,0.85);
  border:2px solid rgba(100,50,180,0.3);
  border-radius:8px;padding:7px 8px 6px;
  cursor:pointer;transition:border-color .15s,background .15s;
  user-select:none;-webkit-user-select:none;
}
.tnode:hover:not(.locked):not(.maxed){border-color:rgba(200,120,255,0.6);background:rgba(30,10,60,0.9);}
.tnode.unlocked{border-color:rgba(255,180,40,0.5);background:rgba(20,10,5,0.9);}
.tnode.maxed{border-color:rgba(255,200,80,0.8);background:rgba(30,18,0,0.95);}
.tnode.locked{opacity:0.4;cursor:not-allowed;}
.tnode.can-afford{border-color:rgba(100,255,100,0.4);}

.tn-top{display:flex;align-items:center;gap:6px;}
.tn-icon{font-size:clamp(18px,3vw,24px);flex-shrink:0;line-height:1;}
.tn-info{flex:1;min-width:0;}
.tn-name{font-family:'Fredoka One',sans-serif;font-size:clamp(10px,1.8vw,13px);color:#eeddcc;letter-spacing:.5px;line-height:1.2;}
.tn-ranks{font-family:'Fredoka One',sans-serif;font-size:10px;color:rgba(255,200,100,0.5);margin-top:1px;}
.tnode.unlocked .tn-ranks{color:#ffcc44;}
.tnode.maxed .tn-ranks{color:#ffee88;}

.tn-desc{font-family:'Nunito',sans-serif;font-size:clamp(9px,1.5vw,11px);color:rgba(200,180,160,0.7);margin-top:4px;line-height:1.4;}
.tnode.unlocked .tn-desc,.tnode.maxed .tn-desc{color:rgba(220,200,160,0.85);}

.tn-cost{
  font-family:'Fredoka One',sans-serif;font-size:10px;
  color:rgba(255,180,80,0.6);margin-top:3px;
}
.tnode.maxed .tn-cost{color:rgba(255,220,80,0.4);}

/* Connector lines between tiers */
.tree-connector{
  width:2px;height:12px;
  background:linear-gradient(to bottom,rgba(150,80,255,0.3),rgba(150,80,255,0.1));
  margin:0 auto;
}

/* Rank pips */
.tn-pips{display:flex;gap:3px;margin-top:4px;}
.pip{width:10px;height:4px;border-radius:2px;background:rgba(100,50,180,0.3);border:1px solid rgba(150,80,255,0.2);}
.pip.filled{background:#ffcc44;border-color:#ff9900;}
.tnode.maxed .pip.filled{background:#ffee44;border-color:#ffcc00;}

/* Tooltip */
.tn-bonus{font-family:'Fredoka One',sans-serif;font-size:10px;color:#88ff88;margin-top:2px;}
</style>
</head>
<body>
<div id="shell">
<div id="wrapper">
  <canvas id="gc" width="900" height="640"></canvas>

  <div id="hud">
    <div class="hpill"><div class="hlabel">Waves</div><div class="hval" id="h-wave">0</div></div>
    <div class="hpill"><div class="hlabel">ğŸœ Kill</div><div class="hval" id="h-kills">0/0</div></div>
    <div class="hpill"><div class="hlabel">ğŸœ Pts</div><div class="hval purple" id="h-pts">0</div></div>
    <div class="hpill"><div class="hlabel">Best</div><div class="hval" id="h-hi">0</div></div>
  </div>
  <button id="pause-btn" onclick="togglePause()">â¸ TALENTS</button>

  <div id="fhwrap"><div id="fhlabel2">ğŸ§º PICNIC</div><div id="fhbg2"><div id="fhbar2"></div></div></div>
  <div id="pwrup-banner"></div>
  <div id="decoy-ui"><div id="decoy-count"></div><div id="decoy-hint"></div></div>
  <div id="wave-text"></div>
  <div id="bite-flash"></div>

  <!-- â•â• TALENT TREE OVERLAY â•â• -->
  <div id="talent-overlay" class="hidden">
    <div class="talent-header">
      <div class="talent-title">ğŸ”® TALENT GRIMOIRE</div>
      <div class="talent-currency">ğŸœ <span id="talent-pts-display">0</span> pts to spend</div>
      <button class="talent-close" onclick="closeTalents()">â–¶ RESUME</button>
    </div>
    <div class="talent-trees" id="talent-trees-root"></div>
  </div>

  <!-- START -->
  <div class="screen" id="screen-start">
    <div class="stitle">â˜€ï¸ FRY DAY</div>
    <div class="ssub">Picnic Panic â€” Defend The Spread!</div>
    <div class="sdiv"></div>
    <div class="howgrid">
      <div><strong>MOVE</strong> â€” Aim magnifying glass</div>
      <div><strong>SCROLL</strong> â€” Raise/lower glass height</div>
      <div><strong>SWEET SPOT</strong> â€” Bright dot = max burn</div>
      <div><strong>â¸ TALENTS</strong> â€” Spend ant kills on powers</div>
      <div>ğŸ”¥ Inferno Tree â€” Raw beam power</div>
      <div>ğŸ¯ Sniper Tree â€” Precision damage</div>
      <div>â˜ ï¸ Chaos Tree â€” Explosions & curses</div>
      <div>ğŸ• Collect decoys to divert ants</div>
    </div>
    <div class="howgrid" style="margin-top:3px;font-size:11px">
      <div>ğŸ“± <strong>iPhone:</strong> Drag above finger</div>
      <div>Pinch = adjust glass height</div>
    </div>
    <button class="btn" onclick="startGame()">BURN 'EM</button>
  </div>

  <!-- GAME OVER -->
  <div class="screen hidden" id="screen-over">
    <div class="stitle red">DEVOURED!</div>
    <div class="ssub">The ants ate everything</div>
    <div class="sdiv"></div>
    <div class="srow">
      <div class="sbox"><div class="sbox-l">Waves</div><div class="sbox-v" id="final-wave">0</div></div>
      <div class="sbox"><div class="sbox-l">Ants Fried</div><div class="sbox-v" id="final-ants">0</div></div>
      <div class="sbox"><div class="sbox-l">Best</div><div class="sbox-v" id="final-hi">0</div></div>
    </div>
    <button class="btn" onclick="startGame()">TRY AGAIN</button>
  </div>
</div>

<!-- ctrl bar (mobile) -->
<div id="ctrl-bar">
  <button class="mob-btn decoy-btn" ontouchstart="mobilePlaceDecoy(event)">ğŸ• DECOY</button>
  <div id="fhwrap-bar"><div id="fhlabel">ğŸ§º PICNIC</div><div id="fhbg"><div id="fhbar"></div></div></div>
  <button class="mob-btn talent-btn" ontouchstart="togglePause(event)">ğŸ”® TALENTS</button>
  <button class="mob-btn focus-btn" ontouchstart="mobileFocusToggle(event)">ğŸ”¥ FOCUS</button>
</div>
</div><!-- end shell -->

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CANVAS + CONSTANTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const canvas = document.getElementById('gc');
const ctx = canvas.getContext('2d');
const CW = 900, CH = 640;

const isTouchDevice = ('ontouchstart' in window) || navigator.maxTouchPoints > 0;
if (isTouchDevice) {
  document.getElementById('ctrl-bar').classList.add('visible');
  document.getElementById('fhwrap').style.display = 'none';
  document.body.style.cursor = 'none';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TALENT TREE DEFINITIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// Each talent: id, tree, tier, maxRank, costPerRank, icon, name, desc, effect(ranks)
// effect = function(currentRank) returning description of bonus
const TALENT_DEFS = [

  // â•â• FIRE TREE (raw beam power) â•â•
  {id:'solar_intensity', tree:'fire', tier:0, maxRank:5, cost:3,
   icon:'â˜€ï¸', name:'Solar Intensity',
   desc:'Increases base beam damage per rank.',
   bonus: r => `+${r*20}% beam damage`,
   effect: t => { t.beamDmgMult = 1 + t.ranks('solar_intensity')*0.20; }
  },
  {id:'wide_lens', tree:'fire', tier:1, maxRank:3, cost:5,
   icon:'ğŸ”', name:'Wide Lens',
   desc:'Increases burn radius at all glass heights.',
   requires:['solar_intensity'],
   bonus: r => `+${r*15}% burn radius`,
   effect: t => { t.radBonus = 1 + t.ranks('wide_lens')*0.15; }
  },
  {id:'sustained_heat', tree:'fire', tier:1, maxRank:3, cost:5,
   icon:'ğŸŒ¡ï¸', name:'Sustained Heat',
   desc:'Burn lingers on ants after leaving the beam â€” they keep taking damage for a moment.',
   requires:['solar_intensity'],
   bonus: r => `${r} second burn linger`,
   effect: t => { t.burnLinger = t.ranks('sustained_heat') * 60; } // frames
  },
  {id:'inferno_core', tree:'fire', tier:2, maxRank:1, cost:15,
   icon:'ğŸ”¥', name:'Inferno Core',
   desc:'The sweet spot becomes twice as powerful and glows deep red.',
   requires:['wide_lens','sustained_heat'],
   bonus: r => r ? '2Ã— sweet spot damage' : '',
   effect: t => { t.infernoCore = t.ranks('inferno_core') > 0; }
  },
  {id:'solar_flare', tree:'fire', tier:3, maxRank:1, cost:25,
   icon:'ğŸ’¥', name:'Solar Flare',
   desc:'Every 8 seconds while burning, unleash a flare that auto-kills all ants in a large area.',
   requires:['inferno_core'],
   bonus: r => r ? 'Flare every 8s while burning' : '',
   effect: t => { t.solarFlare = t.ranks('solar_flare') > 0; }
  },

  // â•â• SNIPER TREE (precision) â•â•
  {id:'focused_optics', tree:'sniper', tier:0, maxRank:5, cost:3,
   icon:'ğŸ¯', name:'Focused Optics',
   desc:'Narrows the sweet spot but greatly increases its damage bonus.',
   bonus: r => `+${r*25}% sweet spot damage, âˆ’${r*5}% sweet spot radius`,
   effect: t => { t.sniperDmgBonus = 1 + t.ranks('focused_optics')*0.25; t.sniperRadMalus = 1 - t.ranks('focused_optics')*0.05; }
  },
  {id:'hair_trigger', tree:'sniper', tier:1, maxRank:3, cost:5,
   icon:'âš¡', name:'Hair Trigger',
   desc:'Ants that enter the beam die faster â€” reduces HP threshold for insta-kill.',
   requires:['focused_optics'],
   bonus: r => `${r*15}% faster kill`,
   effect: t => { t.hairTrigger = 1 + t.ranks('hair_trigger')*0.15; }
  },
  {id:'glass_shards', tree:'sniper', tier:1, maxRank:3, cost:5,
   icon:'ğŸ’', name:'Glass Shards',
   desc:'Killing an ant has a chance to send glass shards that deal minor damage to nearby ants.',
   requires:['focused_optics'],
   bonus: r => `${r*15}% shard chance`,
   effect: t => { t.shardChance = t.ranks('glass_shards')*0.15; }
  },
  {id:'killshot', tree:'sniper', tier:2, maxRank:1, cost:15,
   icon:'ğŸ¹', name:'Kill Shot',
   desc:'Landing a sweet-spot kill has a 25% chance to chain-kill the nearest ant for free.',
   requires:['hair_trigger','glass_shards'],
   bonus: r => r ? '25% chain-kill on sweet spot' : '',
   effect: t => { t.killshot = t.ranks('killshot') > 0; }
  },
  {id:'death_ray', tree:'sniper', tier:3, maxRank:1, cost:25,
   icon:'â˜„ï¸', name:'Death Ray',
   desc:'Permanently unlocks an alternate mode: tap R/double-tap to switch to a narrow ultra-beam that pierces and kills in one frame.',
   requires:['killshot'],
   bonus: r => r ? 'Unlock Death Ray mode (R key / double tap)' : '',
   effect: t => { t.deathRay = t.ranks('death_ray') > 0; }
  },

  // â•â• CHAOS TREE (explosions, curses, madness) â•â•
  {id:'volatile_ants', tree:'chaos', tier:0, maxRank:5, cost:3,
   icon:'ğŸ’£', name:'Volatile Ants',
   desc:'Ants killed by the beam have a chance to explode, dealing splash damage to neighbors.',
   bonus: r => `${r*10}% explosion chance, ${r*8} splash dmg`,
   effect: t => { t.explodeChance = t.ranks('volatile_ants')*0.10; t.explodeDmg = t.ranks('volatile_ants')*8; }
  },
  {id:'fire_ant_curse', tree:'chaos', tier:1, maxRank:3, cost:5,
   icon:'ğŸ©¸', name:'Fire Ant Curse',
   desc:'Burning ants periodically scream and slow nearby ants â€” panic spreads.',
   requires:['volatile_ants'],
   bonus: r => `Panic spreads ${r} tiles`,
   effect: t => { t.panicSpread = t.ranks('fire_ant_curse')*35; }
  },
  {id:'chain_reaction', tree:'chaos', tier:1, maxRank:3, cost:6,
   icon:'â›“ï¸', name:'Chain Reaction',
   desc:'Explosions can trigger other explosions â€” up to a chain of this rank deep.',
   requires:['volatile_ants'],
   bonus: r => `Chain depth ${r}`,
   effect: t => { t.chainDepth = t.ranks('chain_reaction'); }
  },
  {id:'queen_finder', tree:'chaos', tier:2, maxRank:1, cost:15,
   icon:'ğŸ‘‘', name:'Queen Finder',
   desc:'Every 4th wave spawns a Queen Ant. Killing her instantly ends the wave and grants 50 bonus points.',
   requires:['fire_ant_curse','chain_reaction'],
   bonus: r => r ? 'Queens spawn every 4th wave (+50pts)' : '',
   effect: t => { t.queenFinder = t.ranks('queen_finder') > 0; }
  },
  {id:'apocalypse_lens', tree:'chaos', tier:3, maxRank:1, cost:30,
   icon:'ğŸŒ‹', name:'Apocalypse Lens',
   desc:'Once per wave, if the picnic drops below 20% health, automatically triggers a massive screen-wide burn event.',
   requires:['queen_finder'],
   bonus: r => r ? 'Emergency burn saves at 20% health' : '',
   effect: t => { t.apocalypse = t.ranks('apocalypse_lens') > 0; }
  },

  // â•â• UTILITY / PASSIVE â•â•
  {id:'ant_magnet', tree:'fire', tier:1, maxRank:2, cost:4,
   icon:'ğŸ§²', name:'Ant Magnet',
   desc:'Ants are slightly attracted toward the beam center â€” easier to group-burn.',
   requires:['solar_intensity'],
   bonus: r => `Pull strength ${r}`,
   effect: t => { t.antMagnet = t.ranks('ant_magnet')*0.4; }
  },
  {id:'decoy_mastery', tree:'sniper', tier:2, maxRank:3, cost:4,
   icon:'ğŸ•', name:'Decoy Mastery',
   desc:'Decoys last longer and attract ants from further away.',
   requires:['focused_optics'],
   bonus: r => `+${r*30}% decoy duration & range`,
   effect: t => { t.decoyMult = 1 + t.ranks('decoy_mastery')*0.30; }
  },
  {id:'fast_focus', tree:'sniper', tier:0, maxRank:3, cost:3,
   icon:'ğŸ”­', name:'Fast Focus',
   desc:'The sweet spot window is wider â€” easier to maintain max damage.',
   bonus: r => `+${r*10}% sweet spot height range`,
   effect: t => { t.focusWindow = 1 + t.ranks('fast_focus')*0.10; }
  },
  {id:'thick_glass', tree:'fire', tier:0, maxRank:3, cost:3,
   icon:'ğŸº', name:'Thick Glass',
   desc:'Beam maintains partial power even at non-ideal heights.',
   bonus: r => `+${r*8}% off-axis power`,
   effect: t => { t.thickGlass = t.ranks('thick_glass')*0.08; }
  },
  {id:'picnic_shield', tree:'chaos', tier:0, maxRank:3, cost:4,
   icon:'ğŸ›¡ï¸', name:'Picnic Shield',
   desc:'Ants bite the picnic for slightly less damage.',
   bonus: r => `âˆ’${r*10}% bite damage`,
   effect: t => { t.biteDmgReduce = 1 - t.ranks('picnic_shield')*0.10; }
  },
  {id:'double_decoy', tree:'chaos', tier:2, maxRank:1, cost:10,
   icon:'ğŸ”', name:'Double Decoy',
   desc:'Gain an extra decoy every time a powerup spawns.',
   requires:['volatile_ants'],
   bonus: r => r ? 'Extra decoy on every powerup' : '',
   effect: t => { t.doubleDecoy = t.ranks('double_decoy') > 0; }
  },
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TALENT STATE + COMPUTED STATS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let talentPoints = 0; // spendable ant kills
let talentRanks = {}; // id -> current rank

function ranks(id){ return talentRanks[id] || 0; }

// Computed stat block â€” rebuilt whenever talents change
let T = {};
function rebuildStats() {
  T = {
    beamDmgMult:1, radBonus:1, burnLinger:0, infernoCore:false,
    solarFlare:false, sniperDmgBonus:1, sniperRadMalus:1, hairTrigger:1,
    shardChance:0, killshot:false, deathRay:false,
    explodeChance:0, explodeDmg:0, panicSpread:0, chainDepth:0,
    queenFinder:false, apocalypse:false, antMagnet:0,
    decoyMult:1, focusWindow:1, thickGlass:0, biteDmgReduce:1, doubleDecoy:false,
    ranks
  };
  TALENT_DEFS.forEach(td => { if (ranks(td.id) > 0) td.effect(T); });
}
rebuildStats();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let state = 'start'; // start | play | paused | over
let wavesSurvived=0, antsFried=0, wave=0;
let foodHealth=100;
let hiScore=parseInt(localStorage.getItem('fryday_hi')||'0');
let frameId;
let paused=false;
let solarFlareTimer=0, apocalypseUsed=false;
let deathRayMode=false;

// Glass
let glass={x:CW/2,y:CH/2-60,height:160};
const GLASS_MIN=50,GLASS_MAX=320,GLASS_R=42;
let beamX=CW/2,beamY=CH/2,burnRadius=12,burnIntensity=0;

const PICNIC={x:CW/2,y:CH/2+20,rx:120,ry:72};

// Powerups
let activePowerup=null;
let powerupDrops=[];
const PWRUP_TYPES=['instakill','doublepoints','superbeam'];
const PWRUP_COLORS={instakill:'#ff3344',doublepoints:'#ffcc00',superbeam:'#ff6600'};
const PWRUP_LABELS={instakill:'â˜ ï¸ INSTANT KILL!',doublepoints:'âœ–ï¸2 DOUBLE POINTS!',superbeam:'ğŸ”¥ SUPER BEAM!'};
let pwrupSpawnTimer=0;

// Decoys
let decoyCount=0,decoys=[],decoyMode=false,mobileDecoyReady=false;

// Holes + ants
let holes=[],ants=[],queenAnt=null;

// FX
let embers=[],smokeParticles=[],biteAnims=[],floatTexts=[],explosions=[];

// Wave
let waveAntQuota=0, waveAntsSpawned=0, betweenWaves=false, betweenTimer=0;

function updateWaveProgress(){
  const killed = antsFried; // running total â€” we track per-wave kills via waveAntsSpawned
  const el = document.getElementById('h-wave');
  if(el) el.textContent = wavesSurvived;
  // Update a kill-progress display in the HUD pill
  const kEl = document.getElementById('h-kills');
  if(kEl) kEl.textContent = `${Math.min(waveAntsSpawned, waveAntQuota)}/${waveAntQuota}`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TALENT TREE UI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildTalentUI() {
  const root = document.getElementById('talent-trees-root');
  root.innerHTML = '';
  const trees = {
    fire:  {label:'ğŸ”¥ INFERNO',   cls:'fire'},
    sniper:{label:'ğŸ¯ SNIPER',    cls:'sniper'},
    chaos: {label:'â˜ ï¸ CHAOS',     cls:'chaos'},
  };
  // Sort by tree then tier
  const byTree = {};
  TALENT_DEFS.forEach(td => { (byTree[td.tree]||(byTree[td.tree]=[])).push(td); });

  Object.keys(trees).forEach(tKey => {
    const {label,cls} = trees[tKey];
    const col = document.createElement('div');
    col.className = 'talent-tree';

    const header = document.createElement('div');
    header.className = `tree-name ${cls}`;
    header.textContent = label;
    col.appendChild(header);

    const tds = (byTree[tKey]||[]).sort((a,b)=>a.tier-b.tier);
    // Group by tier
    const tiers = {};
    tds.forEach(td => (tiers[td.tier]||(tiers[td.tier]=[])).push(td));

    Object.keys(tiers).sort().forEach((tier,ti) => {
      if (ti > 0) {
        const conn = document.createElement('div');
        conn.className = 'tree-connector';
        col.appendChild(conn);
      }
      tiers[tier].forEach(td => {
        col.appendChild(makeTNode(td));
      });
    });

    root.appendChild(col);
  });
}

function makeTNode(td) {
  const div = document.createElement('div');
  div.className = 'tnode';
  div.id = 'tn_'+td.id;
  div.addEventListener('click', ()=>buyTalent(td.id));
  div.addEventListener('touchend', e=>{e.preventDefault();buyTalent(td.id);});
  refreshTNode(div, td);
  return div;
}

function refreshTNode(div, td) {
  const r = ranks(td.id);
  const maxed = r >= td.maxRank;
  const locked = isLocked(td);
  const canAfford = talentPoints >= td.cost && !locked && !maxed;

  div.className = 'tnode' + (maxed?' maxed':r>0?' unlocked':locked?' locked':canAfford?' can-afford':'');

  const bonus = td.bonus(r);
  const nextBonus = !maxed ? td.bonus(r+1) : '';

  div.innerHTML = `
    <div class="tn-top">
      <div class="tn-icon">${td.icon}</div>
      <div class="tn-info">
        <div class="tn-name">${td.name}</div>
        <div class="tn-ranks">${r}/${td.maxRank}</div>
      </div>
    </div>
    <div class="tn-pips">${Array.from({length:td.maxRank},(_,i)=>`<div class="pip${i<r?' filled':''}"></div>`).join('')}</div>
    <div class="tn-desc">${td.desc}</div>
    ${r>0?`<div class="tn-bonus">â–¶ ${bonus}</div>`:''}
    ${!maxed?`<div class="tn-cost">${maxed?'MAXED':`Cost: ${td.cost} ğŸœ pts â†’ ${nextBonus}`}</div>`:'<div class="tn-cost" style="color:#ffdd88">âœ“ MAXED</div>'}
  `;
}

function isLocked(td) {
  if (!td.requires || td.requires.length === 0) return false;
  return !td.requires.every(req => ranks(req) > 0);
}

function buyTalent(id) {
  const td = TALENT_DEFS.find(t=>t.id===id);
  if (!td) return;
  if (isLocked(td)) return;
  if (ranks(td.id) >= td.maxRank) return;
  if (talentPoints < td.cost) return;

  talentPoints -= td.cost;
  talentRanks[id] = (talentRanks[id]||0) + 1;
  rebuildStats();
  refreshAllTNodes();
  document.getElementById('talent-pts-display').textContent = talentPoints;
  document.getElementById('h-pts').textContent = talentPoints;
}

function refreshAllTNodes() {
  TALENT_DEFS.forEach(td => {
    const div = document.getElementById('tn_'+td.id);
    if (div) refreshTNode(div, td);
  });
}

function togglePause(e) {
  if (e && e.preventDefault) e.preventDefault();
  if (state === 'over' || state === 'start') return;
  if (state === 'play') {
    state = 'paused';
    paused = true;
    document.getElementById('talent-overlay').classList.remove('hidden');
    document.getElementById('talent-pts-display').textContent = talentPoints;
    buildTalentUI();
    document.getElementById('pause-btn').textContent = 'â–¶ RESUME';
  } else if (state === 'paused') {
    closeTalents();
  }
}

function closeTalents() {
  state = 'play';
  paused = false;
  document.getElementById('talent-overlay').classList.add('hidden');
  document.getElementById('pause-btn').textContent = 'â¸ TALENTS';
  rebuildStats();
  if (!frameId) gameLoop();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INPUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getCanvasPos(cx,cy){
  const r=canvas.getBoundingClientRect();
  return{x:(cx-r.left)*(CW/r.width),y:(cy-r.top)*(CH/r.height)};
}
canvas.addEventListener('mousemove',e=>{
  if(state!=='play')return;
  const p=getCanvasPos(e.clientX,e.clientY);
  glass.x=p.x;glass.y=p.y;
});
canvas.addEventListener('click',e=>{
  if(state!=='play')return;
  if((decoyMode||mobileDecoyReady)&&decoyCount>0){
    const p=getCanvasPos(e.clientX,e.clientY);
    placeDecoy(p.x,p.y);
  }
});
canvas.addEventListener('wheel',e=>{
  e.preventDefault();
  glass.height=clamp(glass.height+e.deltaY*0.4,GLASS_MIN,GLASS_MAX);
},{passive:false});
canvas.addEventListener('contextmenu',e=>{
  e.preventDefault();
  if(state==='play'&&decoyCount>0){const p=getCanvasPos(e.clientX,e.clientY);placeDecoy(p.x,p.y);}
});

// Death ray / double-tap
let lastTap=0;
canvas.addEventListener('dblclick',()=>{if(T.deathRay)deathRayMode=!deathRayMode;});
document.addEventListener('keydown',e=>{
  if(e.key==='r'||e.key==='R'){if(state==='play'&&T.deathRay)deathRayMode=!deathRayMode;}
  if(e.key==='d'||e.key==='D'){if(state==='play'&&decoyCount>0){decoyMode=!decoyMode;document.body.classList.toggle('decoy-mode',decoyMode);}}
  if(e.key==='Escape'||e.key===' ')togglePause();
});

// Touch
const TOUCH_OFFSET_X=-18, TOUCH_OFFSET_Y=-110;
function applyTouchOffset(p){
  const r=canvas.getBoundingClientRect();
  return{x:clamp(p.x+TOUCH_OFFSET_X*(CW/r.width),GLASS_R+5,CW-GLASS_R-5),
         y:clamp(p.y+TOUCH_OFFSET_Y*(CH/r.height),GLASS_R+5,CH-GLASS_R-5)};
}
let lastPinchDist=null;
canvas.addEventListener('touchstart',e=>{
  e.preventDefault();
  if(state!=='play')return;
  if(e.touches.length===1){
    // double tap for death ray
    const now=Date.now();
    if(now-lastTap<300&&T.deathRay)deathRayMode=!deathRayMode;
    lastTap=now;
    if((decoyMode||mobileDecoyReady)&&decoyCount>0){
      const p=getCanvasPos(e.touches[0].clientX,e.touches[0].clientY);
      placeDecoy(p.x,p.y);mobileDecoyReady=false;return;
    }
    const raw=getCanvasPos(e.touches[0].clientX,e.touches[0].clientY);
    const off=applyTouchOffset(raw);glass.x=off.x;glass.y=off.y;
  }
},{passive:false});
canvas.addEventListener('touchmove',e=>{
  e.preventDefault();
  if(state!=='play')return;
  if(e.touches.length===1){
    const raw=getCanvasPos(e.touches[0].clientX,e.touches[0].clientY);
    const off=applyTouchOffset(raw);glass.x=off.x;glass.y=off.y;
    lastPinchDist=null;
  } else if(e.touches.length===2){
    const t1=e.touches[0],t2=e.touches[1];
    const d=Math.hypot(t2.clientX-t1.clientX,t2.clientY-t1.clientY);
    if(lastPinchDist!==null)glass.height=clamp(glass.height+(lastPinchDist-d)*1.2,GLASS_MIN,GLASS_MAX);
    lastPinchDist=d;
    const mx=(t1.clientX+t2.clientX)/2,my=(t1.clientY+t2.clientY)/2;
    const raw=getCanvasPos(mx,my);const off=applyTouchOffset(raw);
    glass.x=off.x;glass.y=off.y;
  }
},{passive:false});
canvas.addEventListener('touchend',e=>{
  e.preventDefault();
  if(e.touches.length<2)lastPinchDist=null;
},{passive:false});

function mobilePlaceDecoy(e){e.preventDefault();if(decoyCount>0){mobileDecoyReady=true;showPwrupBanner('ğŸ‘† TAP TO DROP DECOY','#ffcc44',2500);}}
function mobileFocusToggle(e){e.preventDefault();glass.height=glass.height>130?100:180;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startGame(){
  document.getElementById('screen-start').classList.add('hidden');
  document.getElementById('screen-over').classList.add('hidden');
  document.getElementById('talent-overlay').classList.add('hidden');
  wavesSurvived=0;antsFried=0;wave=0;foodHealth=100;
  talentPoints=0;talentRanks={};rebuildStats();
  ants=[];holes=[];embers=[];smokeParticles=[];biteAnims=[];floatTexts=[];explosions=[];
  powerupDrops=[];activePowerup=null;pwrupSpawnTimer=180;
  decoys=[];decoyCount=0;decoyMode=false;mobileDecoyReady=false;
  betweenWaves=false;paused=false;solarFlareTimer=0;apocalypseUsed=false;deathRayMode=false;
  waveAntQuota=0;waveAntsSpawned=0;
  state='play';
  document.getElementById('h-hi').textContent=hiScore;
  document.getElementById('pause-btn').textContent='â¸ TALENTS';
  beginWave();updateHUD();
  if(!frameId)gameLoop();
}

function beginWave(){
  wave++;betweenWaves=false;
  // Ant quota: how many must be SPAWNED before holes close. Kill them all to clear.
  waveAntQuota = 8 + wave * 6;   // wave 1=14, wave 2=20, wave 3=26...
  waveAntsSpawned = 0;
  const maxHoles=Math.min(wave,6);
  while(holes.length<maxHoles)addHole();
  holes.forEach(h=>{h.spawnRate=Math.max(18,85-wave*7);h.spawnTimer=0;});
  if(T.queenFinder && wave%4===0) spawnQueen();
  showWaveText(`WAVE ${wave}! â€” Kill ${waveAntQuota} ants`);
  document.getElementById('h-wave').textContent=wavesSurvived;
  updateWaveProgress();
  apocalypseUsed=false;
  solarFlareTimer=0;
}

function addHole(){
  let hx,hy,tries=0;
  do{hx=rand(55,CW-55);hy=rand(55,CH-55);tries++;}
  while(tries<30&&(dist(hx,hy,PICNIC.x,PICNIC.y)<PICNIC.rx+65||holes.some(h=>dist(hx,hy,h.x,h.y)<95)));
  holes.push({x:hx,y:hy,pulse:0,spawnTimer:0,spawnRate:Math.max(18,85-wave*7),active:true});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   POWERUPS + DECOYS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function spawnPowerup(){
  const type=PWRUP_TYPES[Math.floor(Math.random()*PWRUP_TYPES.length)];
  let px,py,tries=0;
  do{px=rand(60,CW-60);py=rand(80,CH-80);tries++;}
  while(tries<20&&dist(px,py,PICNIC.x,PICNIC.y)<100);
  powerupDrops.push({x:px,y:py,type,pulse:0,life:600});
}
function collectPowerup(drop){
  activePowerup={type:drop.type,timer:drop.type==='superbeam'?600:drop.type==='instakill'?400:500,maxTimer:drop.type==='superbeam'?600:400};
  showPwrupBanner(PWRUP_LABELS[drop.type],PWRUP_COLORS[drop.type],2500);
  if(T.doubleDecoy)grantDecoy();
}
function grantDecoy(){
  decoyCount=Math.min(decoyCount+1,5);updateDecoyUI();
  showPwrupBanner('ğŸ• DECOY GRANTED!','#ffaa00',1600);
}
function placeDecoy(x,y){
  if(isInPicnic(x,y))return;
  decoyCount--;
  const duration=(900+wave*60)*T.decoyMult;
  decoys.push({x,y,life:duration,maxLife:duration,pulse:0});
  decoyMode=false;document.body.classList.remove('decoy-mode');updateDecoyUI();
}
function isInPicnic(x,y){const dx=(x-PICNIC.x)/PICNIC.rx,dy=(y-PICNIC.y)/PICNIC.ry;return dx*dx+dy*dy<1;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPAWN ANT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function spawnAntFromHole(hole){
  const angle=Math.random()*Math.PI*2;
  const spd=0.65+Math.random()*0.4+wave*0.04;
  ants.push({
    x:hole.x+Math.cos(angle)*12,y:hole.y+Math.sin(angle)*12,
    vx:0,vy:0,hp:1,maxHp:1,
    antState:'seek',angle,legPhase:Math.random()*Math.PI*2,
    size:4.5+Math.random()*2.5,speed:spd,
    burnAlpha:0,panic:0,biteTimer:0,
    orbitAngle:angle,orbitDir:Math.random()<0.5?1:-1,
    targetDecoy:null,lingering:0,isQueen:false,
  });
}

function spawnQueen(){
  const hx=rand(60,CW-60),hy=rand(60,CH*0.3);
  queenAnt={
    x:hx,y:hy,vx:0,vy:0,hp:5,maxHp:5,
    antState:'seek',angle:0,legPhase:0,
    size:12,speed:0.4+wave*0.02,
    burnAlpha:0,panic:0,biteTimer:0,
    orbitAngle:0,orbitDir:1,targetDecoy:null,
    lingering:0,isQueen:true,
  };
  ants.push(queenAnt);
  showWaveText('ğŸ‘‘ QUEEN APPROACHES!');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UPDATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function update(){
  if(state!=='play')return;

  // Solar flare timer
  if(T.solarFlare&&burnIntensity>0.5){
    solarFlareTimer++;
    if(solarFlareTimer>=480){solarFlareTimer=0;triggerSolarFlare();}
  }

  // Beam physics
  const optH=105, diff=Math.abs(glass.height-optH);
  const focusWindowMult = T.focusWindow || 1;
  const adjustedDiff = diff / focusWindowMult;
  const rawIntensity = Math.max(0, 1 - adjustedDiff/125 + T.thickGlass);
  burnIntensity = Math.min(1, rawIntensity);
  beamX=glass.x; beamY=glass.y+glass.height*0.55;

  const superBeamActive=activePowerup&&activePowerup.type==='superbeam';
  const baseRadius = 6 + diff*0.22;
  burnRadius = deathRayMode ? 3 : (superBeamActive?(14+diff*0.15):baseRadius*T.radBonus);

  // Death Ray: ultra intense narrow beam
  const isDeathRay = deathRayMode && T.deathRay;
  const effectiveIntensity = isDeathRay ? 3.0
    : superBeamActive ? Math.min(1,burnIntensity*2.2+0.4)
    : burnIntensity * T.beamDmgMult;

  // Powerup timer
  if(activePowerup){activePowerup.timer--;if(activePowerup.timer<=0){activePowerup=null;document.getElementById('pwrup-banner').classList.remove('show');}}

  // Spawn powerups
  pwrupSpawnTimer--;
  if(pwrupSpawnTimer<=0){spawnPowerup();pwrupSpawnTimer=420+Math.floor(Math.random()*240);if(Math.random()<0.35)grantDecoy();}

  // Powerup collection
  for(let i=powerupDrops.length-1;i>=0;i--){
    const p=powerupDrops[i];p.pulse+=0.08;p.life--;
    if(p.life<=0){powerupDrops.splice(i,1);continue;}
    if(dist(p.x,p.y,beamX,beamY)<burnRadius+18&&effectiveIntensity>0.2){collectPowerup(p);powerupDrops.splice(i,1);}
  }

  // Wave / hole spawning
  if(!betweenWaves){
    // Only spawn from holes until the quota is filled
    if(waveAntsSpawned < waveAntQuota){
      holes.forEach(h=>{
        if(!h.active)return;
        h.pulse+=0.07;h.spawnTimer--;
        if(h.spawnTimer<=0){
          spawnAntFromHole(h);
          h.spawnTimer=h.spawnRate+Math.floor(Math.random()*15);
          waveAntsSpawned++;
          updateWaveProgress();
        }
      });
    } else {
      // All ants spawned â€” just pulse holes visually
      holes.forEach(h=>{h.pulse+=0.07;});
    }
    // Wave ends when quota is filled AND all spawned ants are dead
    if(waveAntsSpawned >= waveAntQuota && ants.length===0){
      betweenWaves=true;betweenTimer=220;wavesSurvived++;
      document.getElementById('h-wave').textContent=wavesSurvived;
      if(wavesSurvived>hiScore){hiScore=wavesSurvived;localStorage.setItem('fryday_hi',hiScore);document.getElementById('h-hi').textContent=hiScore;}
      showWaveText(`WAVE ${wave} CLEARED! ğŸ‰`);
    }
  }
  if(betweenWaves){betweenTimer--;if(betweenTimer<=0)beginWave();}

  // Decoys
  for(let i=decoys.length-1;i>=0;i--){
    const d=decoys[i];d.pulse+=0.1;d.life--;
    if(dist(d.x,d.y,beamX,beamY)<burnRadius+20&&effectiveIntensity>0.1)d.life-=4;
    if(d.life<=0){ants.forEach(a=>{if(a.targetDecoy===d){a.antState='seek';a.targetDecoy=null;}});decoys.splice(i,1);}
  }

  // Apocalypse check
  if(T.apocalypse&&!apocalypseUsed&&foodHealth<20&&foodHealth>0){
    apocalypseUsed=true;triggerApocalypse();
  }

  // Ants
  for(let i=ants.length-1;i>=0;i--){
    const a=ants[i];
    a.legPhase+=0.22;
    a.panic=Math.max(0,a.panic-0.016);
    if(a.lingering>0){
      a.lingering--;a.hp-=0.015;
      if(Math.random()<0.1)spawnEmber(a.x,a.y);
    }

    // Beam burn
    const bd=dist(a.x,a.y,beamX,beamY);
    const inBeam=bd<burnRadius&&effectiveIntensity>0.05;
    if(inBeam){
      const instaKill=activePowerup&&activePowerup.type==='instakill';
      let dmg = instaKill ? 1 : effectiveIntensity*0.07*T.hairTrigger;
      // Sniper bonus at sweet spot
      const sweetSpot = burnIntensity > 0.75;
      if(sweetSpot) dmg *= T.sniperDmgBonus * (T.infernoCore?2:1);
      a.hp-=dmg;
      a.burnAlpha=Math.min(1,a.burnAlpha+0.2);
      a.panic=1;
      if(T.burnLinger>0&&a.lingering===0)a.lingering=T.burnLinger;
      if(Math.random()<0.3)spawnEmber(a.x,a.y);
      // Ant magnet
      if(T.antMagnet>0){
        const dx=beamX-a.x,dy=beamY-a.y,dm=Math.hypot(dx,dy)+0.001;
        a.x+=dx/dm*T.antMagnet;a.y+=dy/dm*T.antMagnet;
      }
    } else {
      a.burnAlpha=Math.max(0,a.burnAlpha-0.05);
    }

    if(a.hp<=0){killAnt(a,i,inBeam&&burnIntensity>0.75);continue;}

    // Panic spread from cursed ants
    if(T.panicSpread>0&&a.burnAlpha>0.3){
      ants.forEach(other=>{if(other!==a&&dist(a.x,a.y,other.x,other.y)<T.panicSpread)other.panic=Math.max(other.panic,0.6);});
    }

    // Decoy attraction
    if((a.antState==='seek'||a.antState==='orbit')&&decoys.length>0&&Math.random()<0.015){
      const nearest=decoys.reduce((b,d)=>{const dd=dist(a.x,a.y,d.x,d.y);return(!b||dd<b.d)?{d,dd}:b;},null);
      const attractRadius = 280 * T.decoyMult;
      if(nearest&&nearest.dd<attractRadius){a.antState='decoyseek';a.targetDecoy=nearest.d;}
    }

    if(a.antState==='decoyseek'){
      if(!a.targetDecoy||a.targetDecoy.life<=0){a.antState='seek';a.targetDecoy=null;}
      else{
        const td=a.targetDecoy,dx=td.x-a.x,dy=td.y-a.y,dm=Math.hypot(dx,dy)+0.001;
        if(dm<20){a.antState='decoyorbit';a.orbitAngle=Math.atan2(a.y-td.y,a.x-td.x);}
        else{a.vx=(dx/dm)*a.speed*1.3;a.vy=(dy/dm)*a.speed*1.3;a.angle=Math.atan2(dy,dx);}
      }
    } else if(a.antState==='decoyorbit'){
      const td=a.targetDecoy;
      if(!td||td.life<=0){a.antState='seek';a.targetDecoy=null;}
      else{
        a.orbitAngle+=a.orbitDir*0.012;
        const tx=td.x+Math.cos(a.orbitAngle)*22,ty=td.y+Math.sin(a.orbitAngle)*22;
        a.vx=(tx-a.x)*0.22;a.vy=(ty-a.y)*0.22;a.angle=Math.atan2(a.vy,a.vx);
        a.biteTimer++;if(a.biteTimer%40===0&&td)td.life-=25;
      }
    } else if(a.antState==='seek'){
      const toPicA=Math.atan2(a.y-PICNIC.y,a.x-PICNIC.x);
      const ex=PICNIC.x+Math.cos(toPicA)*PICNIC.rx,ey=PICNIC.y+Math.sin(toPicA)*PICNIC.ry;
      const dEdge=dist(a.x,a.y,ex,ey);
      if(dEdge>18){
        const dx=ex-a.x,dy=ey-a.y,dm=Math.hypot(dx,dy)+0.001;
        a.vx=(dx/dm)*a.speed*(1+a.panic*0.7);a.vy=(dy/dm)*a.speed*(1+a.panic*0.7);a.angle=Math.atan2(dy,dx);
      } else {a.antState='orbit';a.orbitAngle=toPicA;}
    } else if(a.antState==='orbit'){
      a.orbitAngle+=a.orbitDir*(0.009+a.speed*0.003);
      const tx=PICNIC.x+Math.cos(a.orbitAngle)*(PICNIC.rx+9),ty=PICNIC.y+Math.sin(a.orbitAngle)*(PICNIC.ry+9);
      a.vx=(tx-a.x)*0.22;a.vy=(ty-a.y)*0.22;a.angle=Math.atan2(a.vy,a.vx);
      a.biteTimer++;if(a.biteTimer%55===0)bitePicnic(a);
    }

    // Move with ellipse boundary
    let nx=a.x+a.vx,ny=a.y+a.vy;
    const cdx=(nx-PICNIC.x)/PICNIC.rx,cdy=(ny-PICNIC.y)/PICNIC.ry;
    if(cdx*cdx+cdy*cdy<1.0){
      const pa=Math.atan2(ny-PICNIC.y,nx-PICNIC.x);
      nx=PICNIC.x+Math.cos(pa)*(PICNIC.rx+5);ny=PICNIC.y+Math.sin(pa)*(PICNIC.ry+5);
      a.orbitAngle=pa;
      if(a.antState==='orbit'){a.biteTimer++;if(a.biteTimer%55===0)bitePicnic(a);}
    }
    a.x=clamp(nx,3,CW-3);a.y=clamp(ny,30,CH-14);
  }

  // Explosions decay
  for(let i=explosions.length-1;i>=0;i--){
    const ex=explosions[i];ex.r+=4;ex.alpha-=0.06;if(ex.alpha<=0)explosions.splice(i,1);
  }

  // Float texts
  for(let i=floatTexts.length-1;i>=0;i--){const f=floatTexts[i];f.y-=1.2;f.alpha-=0.02;if(f.alpha<=0)floatTexts.splice(i,1);}

  // Particles
  for(let i=embers.length-1;i>=0;i--){const e=embers[i];e.x+=e.vx;e.y+=e.vy;e.vy-=0.04;e.life-=0.026;if(e.life<=0)embers.splice(i,1);}
  for(let i=smokeParticles.length-1;i>=0;i--){const s=smokeParticles[i];s.x+=s.vx;s.y+=s.vy;s.vy-=0.04;s.alpha-=0.007;s.r+=0.26;if(s.alpha<=0)smokeParticles.splice(i,1);}
  for(let i=biteAnims.length-1;i>=0;i--){biteAnims[i].t--;biteAnims[i].r+=1.4;biteAnims[i].alpha-=0.055;if(biteAnims[i].t<=0)biteAnims.splice(i,1);}

  // Health bars
  const pct=foodHealth+'%';
  const hcol=foodHealth>60?'linear-gradient(90deg,#44ff66,#aaff44)':foodHealth>30?'linear-gradient(90deg,#ffcc00,#ff8800)':'linear-gradient(90deg,#ff4400,#ff2200)';
  ['fhbar','fhbar2'].forEach(id=>{const el=document.getElementById(id);if(el){el.style.width=pct;el.style.background=hcol;}});

  if(foodHealth<=0)gameOver();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KILL ANT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function killAnt(ant, idx, sweetSpotKill=false){
  for(let e=0;e<6;e++)spawnEmber(ant.x,ant.y);
  spawnSmoke(ant.x,ant.y);
  if(ant.targetDecoy)ant.targetDecoy=null;
  ants.splice(idx,1);
  antsFried++;
  talentPoints++;
  document.getElementById('h-pts').textContent=talentPoints;

  let pts=1,label='+1',color='#ffcc44';
  if(activePowerup&&activePowerup.type==='instakill'){label='â˜ ï¸';color='#ff3344';}
  if(activePowerup&&activePowerup.type==='doublepoints'){pts=2;label='âœ–ï¸2';color='#ffcc00';}
  if(ant.isQueen){pts=50;label='ğŸ‘‘ +50!';color='#ffaaff';showWaveText('QUEEN SLAIN! +50 pts');}

  floatTexts.push({x:ant.x,y:ant.y,text:label,color,alpha:1,size:ant.isQueen?22:14});
  updateHUD();

  // Explosion talent
  if(T.explodeChance>0&&Math.random()<T.explodeChance){
    triggerExplosion(ant.x,ant.y,T.explodeDmg,T.chainDepth);
  }

  // Glass shards
  if(T.shardChance>0&&Math.random()<T.shardChance){
    ants.forEach(other=>{if(dist(other.x,other.y,ant.x,ant.y)<55)other.hp-=0.3;});
  }

  // Killshot chain
  if(T.killshot&&sweetSpotKill&&Math.random()<0.25&&ants.length>0){
    const nearest=ants.reduce((b,a)=>{const dd=dist(a.x,a.y,ant.x,ant.y);return(!b||dd<b.d)?{a,d:dd}:b;},null);
    if(nearest){
      for(let e=0;e<8;e++)spawnEmber(nearest.a.x,nearest.a.y);
      floatTexts.push({x:nearest.a.x,y:nearest.a.y-15,text:'â›“ï¸ CHAIN!',color:'#88aaff',alpha:1,size:14});
      ants.splice(ants.indexOf(nearest.a),1);antsFried++;talentPoints++;
    }
  }
}

function triggerExplosion(x,y,dmg,chainDepth,depth=0){
  explosions.push({x,y,r:8,alpha:0.9,color:'#ff8800'});
  for(let e=0;e<12;e++)spawnEmber(x+rand(-10,10),y+rand(-10,10));
  const explodeR=45;
  for(let i=ants.length-1;i>=0;i--){
    const a=ants[i];
    if(dist(a.x,a.y,x,y)<explodeR){
      a.hp-=dmg/100;a.panic=1;
      if(a.hp<=0&&depth<chainDepth)triggerExplosion(a.x,a.y,dmg,chainDepth,depth+1);
    }
  }
}

function triggerSolarFlare(){
  showPwrupBanner('â˜€ï¸ SOLAR FLARE!','#ff8800',1800);
  for(let i=ants.length-1;i>=0;i--){
    const a=ants[i];
    if(dist(a.x,a.y,beamX,beamY)<120){
      for(let e=0;e<8;e++)spawnEmber(a.x,a.y);
      ants.splice(i,1);antsFried++;talentPoints++;
    }
  }
  explosions.push({x:beamX,y:beamY,r:20,alpha:1,color:'#ffcc00'});
  updateHUD();
}

function triggerApocalypse(){
  showPwrupBanner('ğŸŒ‹ APOCALYPSE LENS!','#ff4400',2500);
  for(let i=ants.length-1;i>=0;i--){
    const a=ants[i];
    for(let e=0;e<6;e++)spawnEmber(a.x,a.y);
    ants.splice(i,1);antsFried++;talentPoints++;
  }
  for(let ex=0;ex<12;ex++){
    explosions.push({x:rand(50,CW-50),y:rand(50,CH-50),r:10,alpha:1,color:'#ff6600'});
  }
  foodHealth=Math.min(100,foodHealth+15); // slight heal
  updateHUD();
}

function bitePicnic(ant){
  const dmg=(2.5+wave*0.3)*T.biteDmgReduce;
  foodHealth=Math.max(0,foodHealth-dmg);
  biteAnims.push({x:ant.x,y:ant.y,r:4,alpha:1,t:18});
  const fl=document.getElementById('bite-flash');
  fl.classList.add('show');setTimeout(()=>fl.classList.remove('show'),150);
}

function spawnEmber(x,y){embers.push({x,y,vx:rand(-1.5,1.5),vy:rand(-2.8,-0.3),life:rand(0.4,1),r:rand(1.5,4),color:Math.random()<0.5?'#ff8800':Math.random()<0.5?'#ffcc00':'#ff4400'});}
function spawnSmoke(x,y){for(let i=0;i<5;i++)smokeParticles.push({x:x+rand(-8,8),y:y+rand(-4,4),vx:rand(-0.4,0.4),vy:rand(-1.2,-0.2),alpha:rand(0.2,0.45),r:rand(5,13)});}

function gameOver(){
  state='over';
  if(wavesSurvived>hiScore){hiScore=wavesSurvived;localStorage.setItem('fryday_hi',hiScore);}
  document.getElementById('screen-over').classList.remove('hidden');
  document.getElementById('final-wave').textContent=wavesSurvived;
  document.getElementById('final-ants').textContent=antsFried;
  document.getElementById('final-hi').textContent=hiScore;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HUD HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let pwrupBannerTimer=null;
function showPwrupBanner(txt,color,ms){
  const el=document.getElementById('pwrup-banner');
  el.textContent=txt;el.style.color=color;el.classList.add('show');
  clearTimeout(pwrupBannerTimer);pwrupBannerTimer=setTimeout(()=>el.classList.remove('show'),ms);
}
function showWaveText(txt){
  const el=document.getElementById('wave-text');
  el.textContent=txt;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),2100);
}
function updateHUD(){
  document.getElementById('h-pts').textContent=talentPoints;
  document.getElementById('h-wave').textContent=wavesSurvived;
  updateWaveProgress();
}
function updateDecoyUI(){
  const dc=document.getElementById('decoy-count'),dh=document.getElementById('decoy-hint');
  if(decoyCount>0){dc.textContent=`ğŸ• x${decoyCount}`;dh.textContent=isTouchDevice?'TAP BTN':'D or Right-Click';}
  else{dc.textContent='';dh.textContent='';}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DRAW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function draw(){
  ctx.clearRect(0,0,CW,CH);
  drawGround();
  drawDecoys();
  drawHoles();
  drawEmbers();
  drawSmoke();
  drawAnts();
  drawPicnicBlanket();
  drawPicnicFood();
  drawPowerupDrops();
  drawExplosions();
  drawBiteAnims();
  drawFloatTexts();
  drawBurnBeam();
  drawMagnifyingGlass();
  if(activePowerup)drawPowerupTimer();
  if(state==='paused')drawPauseOverlay();
  if(deathRayMode)drawDeathRayCrosshair();
}

function drawPauseOverlay(){
  ctx.save();ctx.fillStyle='rgba(4,1,12,0.15)';ctx.fillRect(0,0,CW,CH);ctx.restore();
}

function drawDeathRayCrosshair(){
  ctx.save();
  ctx.strokeStyle='rgba(100,200,255,0.7)';ctx.lineWidth=1;ctx.setLineDash([4,4]);
  ctx.beginPath();ctx.moveTo(beamX,0);ctx.lineTo(beamX,CH);ctx.stroke();
  ctx.beginPath();ctx.moveTo(0,beamY);ctx.lineTo(CW,beamY);ctx.stroke();
  ctx.setLineDash([]);ctx.restore();
}

function drawGround(){
  const skyG=ctx.createLinearGradient(0,0,0,CH);
  skyG.addColorStop(0,'#74b8e8');skyG.addColorStop(0.47,'#b0daf1');
  skyG.addColorStop(0.49,'#5aad3a');skyG.addColorStop(1,'#38780f');
  ctx.fillStyle=skyG;ctx.fillRect(0,0,CW,CH);
  ctx.fillStyle='rgba(255,255,255,0.7)';
  [[110,55,55,24],[290,38,72,30],[570,50,58,22],[740,40,44,18],[430,65,36,14]].forEach(([cx,cy,rw,rh])=>{
    ctx.beginPath();ctx.ellipse(cx,cy,rw,rh,0,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(cx+rw*0.5,cy+rh*0.2,rw*0.6,rh*0.72,0,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(cx-rw*0.4,cy+rh*0.2,rw*0.52,rh*0.68,0,0,Math.PI*2);ctx.fill();
  });
  const sg=ctx.createRadialGradient(CW*0.87,CH*0.09,0,CW*0.87,CH*0.09,82);
  sg.addColorStop(0,'rgba(255,255,180,1)');sg.addColorStop(0.45,'rgba(255,220,80,0.6)');sg.addColorStop(1,'rgba(255,200,0,0)');
  ctx.fillStyle=sg;ctx.fillRect(0,0,CW,CH);
  ctx.strokeStyle='rgba(42,105,8,0.35)';ctx.lineWidth=1;
  for(let bx=5;bx<CW;bx+=11){const by=CH*0.49+Math.sin(bx*0.22)*3;ctx.beginPath();ctx.moveTo(bx,by);ctx.quadraticCurveTo(bx+3,by-10,bx+1,by-15);ctx.stroke();ctx.beginPath();ctx.moveTo(bx+5,by);ctx.quadraticCurveTo(bx+3,by-7,bx+4,by-11);ctx.stroke();}
}

function drawHoles(){
  holes.forEach(h=>{
    ctx.save();ctx.translate(h.x,h.y);
    const glow=Math.sin(h.pulse)*0.5+0.5;
    const glowR=28+glow*10;
    const glowG=ctx.createRadialGradient(0,0,0,0,0,glowR);
    glowG.addColorStop(0,`rgba(80,20,0,${0.6+glow*0.3})`);glowG.addColorStop(0.5,'rgba(40,10,0,0.3)');glowG.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=glowG;ctx.beginPath();ctx.arc(0,0,glowR,0,Math.PI*2);ctx.fill();
    const holG=ctx.createRadialGradient(0,2,0,0,2,18);
    holG.addColorStop(0,'rgba(0,0,0,0.95)');holG.addColorStop(0.6,'rgba(20,8,0,0.8)');holG.addColorStop(1,'rgba(60,25,0,0.2)');
    ctx.fillStyle=holG;ctx.beginPath();ctx.ellipse(0,3,16,10,0,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle=`rgba(120,60,10,${0.7+glow*0.3})`;ctx.lineWidth=3;
    ctx.beginPath();ctx.ellipse(0,2,17,11,0,0,Math.PI*2);ctx.stroke();
    ctx.fillStyle='rgba(100,55,10,0.6)';
    [[-18,-4],[18,-4],[0,-14],[-12,-12],[12,-12]].forEach(([dx,dy])=>{ctx.beginPath();ctx.ellipse(dx,dy,4+glow*2,3,0,0,Math.PI*2);ctx.fill();});
    ctx.restore();
  });
}

function drawDecoys(){
  decoys.forEach(d=>{
    const lifeRatio=d.life/d.maxLife;
    const glow=Math.sin(d.pulse)*0.4+0.6;
    ctx.save();ctx.translate(d.x,d.y);
    ctx.globalAlpha=glow*0.3*lifeRatio;ctx.fillStyle='#ffaa00';
    ctx.beginPath();ctx.arc(0,0,38,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;
    ctx.shadowColor='rgba(255,160,0,0.5)';ctx.shadowBlur=8;
    ctx.fillStyle=`rgba(255,180,0,${0.7+glow*0.3})`;
    ctx.beginPath();ctx.moveTo(0,0);ctx.arc(0,0,18,-1.0,1.0);ctx.closePath();ctx.fill();
    ctx.fillStyle='rgba(255,220,80,0.85)';ctx.beginPath();ctx.moveTo(0,0);ctx.arc(0,0,14,-0.9,0.9);ctx.closePath();ctx.fill();
    ctx.fillStyle='rgba(220,60,20,0.8)';[[4,-10],[10,-6],[-2,-12]].forEach(([px,py])=>{ctx.beginPath();ctx.arc(px,py,3,0,Math.PI*2);ctx.fill();});
    ctx.fillStyle='rgba(0,0,0,0.35)';ctx.fillRect(-16,22,32,4);
    ctx.fillStyle=lifeRatio>0.5?'#44ff66':lifeRatio>0.25?'#ffcc00':'#ff4400';
    ctx.fillRect(-16,22,32*lifeRatio,4);
    ctx.shadowBlur=0;ctx.restore();
  });
}

function drawPowerupDrops(){
  powerupDrops.forEach(p=>{
    p.pulse+=0.1;const glow=Math.sin(p.pulse)*0.4+0.6;const col=PWRUP_COLORS[p.type];
    ctx.save();ctx.translate(p.x,p.y);
    ctx.globalAlpha=glow*0.35*(p.life/600);ctx.fillStyle=col;
    ctx.beginPath();ctx.arc(0,0,32,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;
    ctx.shadowColor=col;ctx.shadowBlur=12*glow;
    ctx.fillStyle=col;drawStar(ctx,0,0,15,8,5);
    ctx.shadowBlur=0;ctx.fillStyle='rgba(255,255,255,0.9)';
    ctx.font='13px serif';ctx.textAlign='center';ctx.textBaseline='middle';
    const icons={instakill:'â˜ ï¸',doublepoints:'âœ–ï¸2',superbeam:'ğŸ”¥'};
    ctx.fillText(icons[p.type],0,0);ctx.restore();
  });
}
function drawStar(c,cx,cy,or,ir,pts){c.beginPath();for(let i=0;i<pts*2;i++){const r=i%2===0?or:ir,a=i*Math.PI/pts-Math.PI/2;if(i===0)c.moveTo(cx+r*Math.cos(a),cy+r*Math.sin(a));else c.lineTo(cx+r*Math.cos(a),cy+r*Math.sin(a));}c.closePath();c.fill();}

function drawExplosions(){
  explosions.forEach(ex=>{
    ctx.save();ctx.globalAlpha=ex.alpha;
    const eg=ctx.createRadialGradient(ex.x,ex.y,0,ex.x,ex.y,ex.r);
    eg.addColorStop(0,'rgba(255,255,200,0.9)');eg.addColorStop(0.4,'rgba(255,140,0,0.7)');eg.addColorStop(1,'rgba(255,50,0,0)');
    ctx.fillStyle=eg;ctx.beginPath();ctx.arc(ex.x,ex.y,ex.r,0,Math.PI*2);ctx.fill();
    ctx.restore();
  });
}

function drawPicnicBlanket(){
  const{x,y,rx,ry}=PICNIC;
  ctx.save();
  ctx.fillStyle='rgba(0,0,0,0.14)';ctx.beginPath();ctx.ellipse(x+6,y+11,rx*1.05,ry*1.01,0,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#c81a1a';ctx.beginPath();ctx.ellipse(x,y,rx,ry,0,0,Math.PI*2);ctx.fill();
  ctx.save();ctx.beginPath();ctx.ellipse(x,y,rx,ry,0,0,Math.PI*2);ctx.clip();
  const cs=26;ctx.fillStyle='rgba(255,255,255,0.11)';
  for(let cx=x-rx;cx<x+rx;cx+=cs)for(let cy=y-ry;cy<y+ry;cy+=cs){const col=Math.floor((cx-(x-rx))/cs),row=Math.floor((cy-(y-ry))/cs);if((col+row)%2===0)ctx.fillRect(cx,cy,cs,cs);}
  ctx.restore();
  ctx.strokeStyle='rgba(255,220,200,0.25)';ctx.lineWidth=4;ctx.beginPath();ctx.ellipse(x,y,rx-3,ry-3,0,0,Math.PI*2);ctx.stroke();
  ctx.restore();
}

function drawPicnicFood(){
  const{x,y}=PICNIC;const dmg=1-foodHealth/100;
  ctx.save();ctx.translate(x-50,y-10);
  ctx.fillStyle=lerpColor('#e8a040','#774400',dmg*0.65);ctx.beginPath();ctx.ellipse(0,16,27,11,0,0,Math.PI*2);ctx.fill();
  ctx.fillStyle=lerpColor('#6a2e0a','#2a0800',dmg*0.8);ctx.beginPath();ctx.ellipse(0,8,24,8,0,0,Math.PI*2);ctx.fill();
  ctx.fillStyle=lerpColor('#3daa3d','#1a551a',dmg);ctx.beginPath();ctx.ellipse(0,4,26,6,0,0,Math.PI);ctx.fill();
  ctx.fillStyle=lerpColor('#e83822','#771100',dmg);ctx.beginPath();ctx.ellipse(0,0,21,5,0,0,Math.PI);ctx.fill();
  const bG=ctx.createRadialGradient(-3,-16,2,0,-12,26);bG.addColorStop(0,lerpColor('#f0b050','#bb5500',dmg));bG.addColorStop(1,lerpColor('#c07830','#774400',dmg));
  ctx.fillStyle=bG;ctx.beginPath();ctx.arc(0,-12,26,Math.PI,0);ctx.closePath();ctx.fill();ctx.restore();
  ctx.save();ctx.translate(x+4,y-42);
  ctx.fillStyle=lerpColor('#3a9918','#1a5508',dmg);ctx.beginPath();ctx.arc(0,0,29,Math.PI,0);ctx.closePath();ctx.fill();
  ctx.fillStyle=lerpColor('#ff4455','#bb1122',dmg);ctx.beginPath();ctx.arc(0,0,23,Math.PI,0);ctx.closePath();ctx.fill();
  if(dmg<0.9){ctx.fillStyle=lerpColor('#111100','#000',dmg);[[-11,-9],[0,-13],[11,-9],[-6,-5],[6,-5]].forEach(([sx,sy])=>{ctx.beginPath();ctx.ellipse(sx,sy,2.5,3.5,0.2,0,Math.PI*2);ctx.fill();});}
  ctx.restore();
  ctx.save();ctx.translate(x+52,y-6);
  ctx.fillStyle=lerpColor('#e8b060','#7a5520',dmg*0.65);ctx.beginPath();ctx.ellipse(0,11,33,13,0.08,0,Math.PI*2);ctx.fill();
  ctx.fillStyle=lerpColor('#dd4422','#771500',dmg);ctx.beginPath();ctx.ellipse(0,5,27,9,0,0,Math.PI*2);ctx.fill();ctx.restore();
  ctx.save();ctx.translate(x-8,y+32);
  ctx.fillStyle=lerpColor('#cc9838','#664c10',dmg*0.75);ctx.beginPath();ctx.moveTo(0,0);ctx.arc(0,0,26,-0.65,0.65);ctx.closePath();ctx.fill();
  ctx.fillStyle=lerpColor('#bb2a0a','#550f00',dmg);ctx.beginPath();ctx.moveTo(0,0);ctx.arc(0,0,20,-0.55,0.55);ctx.closePath();ctx.fill();ctx.restore();
  ctx.save();ctx.translate(x+90,y+6);
  const cG=ctx.createLinearGradient(-11,0,11,0);cG.addColorStop(0,lerpColor('#bb0000','#550000',dmg*0.45));cG.addColorStop(0.45,lerpColor('#ee1111','#771111',dmg*0.45));cG.addColorStop(1,lerpColor('#990000','#440000',dmg*0.45));
  ctx.fillStyle=cG;ctx.beginPath();ctx.roundRect(-11,-27,22,44,4);ctx.fill();
  ctx.fillStyle=lerpColor('#cccccc','#666',dmg*0.45);ctx.beginPath();ctx.ellipse(0,-27,11,4,0,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.ellipse(0,17,11,4,0,0,Math.PI*2);ctx.fill();ctx.restore();
  if(dmg>0.15){ctx.save();ctx.beginPath();ctx.ellipse(x,y,PICNIC.rx,PICNIC.ry,0,0,Math.PI*2);ctx.clip();ctx.fillStyle=`rgba(60,15,0,${dmg*0.4})`;ctx.fillRect(x-PICNIC.rx,y-PICNIC.ry,PICNIC.rx*2,PICNIC.ry*2);ctx.restore();}
}

function drawAnts(){
  ants.forEach(a=>{
    ctx.save();ctx.translate(a.x,a.y);ctx.rotate(a.angle+Math.PI/2);
    const sz=a.size,b=a.burnAlpha;
    if(b>0){ctx.shadowColor='#ff8800';ctx.shadowBlur=7*b;}
    if(a.isQueen){ctx.shadowColor='#ffaaff';ctx.shadowBlur=15;}
    const bc=a.isQueen?'#aa00aa':b>0.5?'#ff4400':'#160800';
    const lc=a.isQueen?'#cc44cc':b>0.5?'#ff6600':'#251000';
    ctx.strokeStyle=lc;ctx.lineWidth=a.isQueen?1.2:0.8;
    for(let l=0;l<3;l++){const ly=(l-1)*sz*0.7,sw=Math.sin(a.legPhase+l*1.2)*sz*0.6;ctx.beginPath();ctx.moveTo(sz*0.4,ly);ctx.lineTo(sz*1.4+sw,ly+sz*0.5);ctx.stroke();ctx.beginPath();ctx.moveTo(-sz*0.4,ly);ctx.lineTo(-sz*1.4-sw,ly+sz*0.5);ctx.stroke();}
    ctx.fillStyle=bc;
    ctx.beginPath();ctx.ellipse(0,sz*0.9,sz*0.55,sz*0.75,0,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(0,-sz*0.1,sz*0.4,sz*0.45,0,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(0,-sz*0.9,sz*0.38,sz*0.38,0,0,Math.PI*2);ctx.fill();
    if(a.isQueen){ctx.fillStyle='#ffdd00';ctx.font=`${sz*1.2}px serif`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('ğŸ‘‘',-sz*0.1,-sz*1.7);}
    // HP bar for queen
    if(a.isQueen){
      const bw=sz*5,bh=4,bx=-bw/2,by=-sz*2.8;
      ctx.fillStyle='rgba(0,0,0,0.5)';ctx.fillRect(bx,by,bw,bh);
      ctx.fillStyle='#ff44ff';ctx.fillRect(bx,by,bw*(a.hp/a.maxHp),bh);
    }
    ctx.shadowBlur=0;ctx.restore();
  });
}

function drawBiteAnims(){biteAnims.forEach(b=>{ctx.save();ctx.globalAlpha=b.alpha;ctx.strokeStyle='#ff2200';ctx.lineWidth=2;ctx.beginPath();ctx.arc(b.x,b.y,b.r,0,Math.PI*2);ctx.stroke();ctx.restore();});}
function drawEmbers(){embers.forEach(e=>{ctx.save();ctx.globalAlpha=e.life;ctx.fillStyle=e.color;ctx.shadowColor=e.color;ctx.shadowBlur=5;ctx.beginPath();ctx.arc(e.x,e.y,e.r*e.life,0,Math.PI*2);ctx.fill();ctx.restore();});}
function drawSmoke(){smokeParticles.forEach(s=>{ctx.save();ctx.globalAlpha=s.alpha;ctx.fillStyle='#555';ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();ctx.restore();});}
function drawFloatTexts(){floatTexts.forEach(f=>{ctx.save();ctx.globalAlpha=f.alpha;ctx.fillStyle=f.color;ctx.font=`bold ${f.size}px 'Fredoka One'`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.shadowColor='rgba(0,0,0,0.7)';ctx.shadowBlur=4;ctx.fillText(f.text,f.x,f.y);ctx.restore();});}
function drawPowerupTimer(){
  const pct=activePowerup.timer/activePowerup.maxTimer;const col=PWRUP_COLORS[activePowerup.type];
  ctx.save();ctx.strokeStyle=col;ctx.lineWidth=4;ctx.shadowColor=col;ctx.shadowBlur=8;
  ctx.beginPath();ctx.arc(glass.x,glass.y,GLASS_R+10,-Math.PI/2,-Math.PI/2+pct*Math.PI*2);ctx.stroke();ctx.restore();
}

function drawBurnBeam(){
  if(state!=='play'&&state!=='paused')return;
  const superBeam=activePowerup&&activePowerup.type==='superbeam';
  const isDeathRay=deathRayMode&&T.deathRay;
  let i=isDeathRay?1.0:superBeam?Math.min(1,burnIntensity*2.2+0.4):burnIntensity*T.beamDmgMult;
  if(i<0.01)return;
  const gx=glass.x,gy=glass.y,bx=beamX,by=beamY;
  const cTR=GLASS_R*0.6,cBR=burnRadius*0.5;
  const ang=Math.atan2(by-gy,bx-gx),perp=ang+Math.PI/2;
  ctx.save();
  const cg=ctx.createLinearGradient(gx,gy,bx,by);
  const beamCol=isDeathRay?'100,200,255':superBeam?'255,100,0':'255,220,100';
  cg.addColorStop(0,`rgba(255,255,200,${i*0.12})`);cg.addColorStop(0.7,`rgba(${beamCol},${i*0.22})`);cg.addColorStop(1,`rgba(255,140,0,${i*0.08})`);
  ctx.fillStyle=cg;
  ctx.beginPath();
  ctx.moveTo(gx+Math.cos(perp)*cTR,gy+Math.sin(perp)*cTR);
  ctx.lineTo(gx-Math.cos(perp)*cTR,gy-Math.sin(perp)*cTR);
  ctx.lineTo(bx-Math.cos(perp)*cBR,by-Math.sin(perp)*cBR);
  ctx.lineTo(bx+Math.cos(perp)*cBR,by+Math.sin(perp)*cBR);
  ctx.closePath();ctx.fill();
  const innerCol=isDeathRay?'100,200,255':superBeam?'255,180,0':'255,240,100';
  const fg=ctx.createRadialGradient(bx,by,0,bx,by,burnRadius*2.8);
  fg.addColorStop(0,`rgba(255,255,255,${i*0.96})`);fg.addColorStop(0.1,`rgba(${innerCol},${i*0.9})`);
  fg.addColorStop(0.35,`rgba(255,120,0,${i*0.55})`);fg.addColorStop(0.65,`rgba(255,60,0,${i*0.2})`);fg.addColorStop(1,'rgba(255,0,0,0)');
  ctx.fillStyle=fg;ctx.beginPath();ctx.arc(bx,by,burnRadius*2.8,0,Math.PI*2);ctx.fill();
  if(i>0.5){ctx.fillStyle=`rgba(255,255,255,${(i-0.5)*1.8})`;ctx.beginPath();ctx.arc(bx,by,burnRadius*0.4,0,Math.PI*2);ctx.fill();}
  if(T.infernoCore&&burnIntensity>0.75){ctx.strokeStyle=`rgba(255,60,0,${burnIntensity*0.5})`;ctx.lineWidth=2;ctx.beginPath();ctx.arc(bx,by,burnRadius*3.2,0,Math.PI*2);ctx.stroke();}
  ctx.restore();
}

function drawMagnifyingGlass(){
  if(state==='start'||state==='over')return;
  const gx=glass.x,gy=glass.y;
  const superBeam=activePowerup&&activePowerup.type==='superbeam';
  const isDeathRay=deathRayMode&&T.deathRay;
  const frameCol=isDeathRay?['#44aaff','#88ddff','#2288cc']:superBeam?['#ff8800','#ffcc44','#ff6600']:T.infernoCore?['#ff6600','#ffaa44','#cc4400']:['#d4a840','#f0c860','#a07828'];
  ctx.save();
  const lG=ctx.createRadialGradient(gx-GLASS_R*0.3,gy-GLASS_R*0.3,0,gx,gy,GLASS_R);
  lG.addColorStop(0,isDeathRay?'rgba(100,200,255,0.55)':superBeam?'rgba(255,180,100,0.55)':'rgba(200,240,255,0.5)');
  lG.addColorStop(1,isDeathRay?'rgba(50,150,255,0.3)':superBeam?'rgba(255,100,0,0.35)':'rgba(80,160,255,0.3)');
  ctx.fillStyle=lG;ctx.beginPath();ctx.arc(gx,gy,GLASS_R,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='rgba(255,255,255,0.15)';ctx.beginPath();ctx.ellipse(gx-GLASS_R*0.28,gy-GLASS_R*0.28,GLASS_R*0.3,GLASS_R*0.15,-0.6,0,Math.PI*2);ctx.fill();
  const fG=ctx.createLinearGradient(gx-GLASS_R,gy-GLASS_R,gx+GLASS_R,gy+GLASS_R);
  fG.addColorStop(0,frameCol[0]);fG.addColorStop(0.5,frameCol[1]);fG.addColorStop(1,frameCol[2]);
  ctx.strokeStyle=fG;ctx.lineWidth=8;
  if(superBeam||T.infernoCore){ctx.shadowColor=superBeam?'rgba(255,120,0,0.7)':'rgba(255,80,0,0.5)';ctx.shadowBlur=14;}
  if(isDeathRay){ctx.shadowColor='rgba(100,200,255,0.8)';ctx.shadowBlur=18;}
  ctx.beginPath();ctx.arc(gx,gy,GLASS_R,0,Math.PI*2);ctx.stroke();ctx.shadowBlur=0;
  const hA=Math.PI*0.35;
  const hx1=gx+Math.cos(hA)*GLASS_R,hy1=gy+Math.sin(hA)*GLASS_R;
  const hx2=hx1+Math.cos(hA)*68,hy2=hy1+Math.sin(hA)*68;
  const hG=ctx.createLinearGradient(hx1,hy1,hx2,hy2);
  hG.addColorStop(0,'#c09030');hG.addColorStop(0.4,'#8b5a10');hG.addColorStop(1,'#5a3a08');
  ctx.strokeStyle=hG;ctx.lineWidth=11;ctx.lineCap='round';
  ctx.beginPath();ctx.moveTo(hx1,hy1);ctx.lineTo(hx2,hy2);ctx.stroke();
  const oH=105,df=Math.abs(glass.height-oH),ql=Math.max(0,1-df/125);
  ctx.strokeStyle=ql>0.7?'#44ff88':ql>0.35?'#ffcc00':'#ff4422';
  ctx.lineWidth=2.5;ctx.globalAlpha=0.7;
  ctx.beginPath();ctx.arc(gx,gy,GLASS_R+6,-Math.PI/2,-Math.PI/2+ql*Math.PI*2);ctx.stroke();
  ctx.globalAlpha=1;ctx.restore();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function dist(ax,ay,bx,by){return Math.hypot(bx-ax,by-ay);}
function rand(a,b){return a+Math.random()*(b-a);}
function clamp(v,lo,hi){return Math.max(lo,Math.min(hi,v));}
function lerp(a,b,t){return a+(b-a)*t;}
function lerpColor(c1,c2,t){
  const parse=c=>{if(c.startsWith('rgba')){const m=c.match(/[\d.]+/g);return[+m[0],+m[1],+m[2],+m[3]];}if(c.startsWith('rgb')){const m=c.match(/[\d.]+/g);return[+m[0],+m[1],+m[2],1];}return[parseInt(c.slice(1,3),16),parseInt(c.slice(3,5),16),parseInt(c.slice(5,7),16),1];};
  const[r1,g1,b1,a1]=parse(c1),[r2,g2,b2,a2]=parse(c2);
  return`rgba(${Math.round(lerp(r1,r2,t))},${Math.round(lerp(g1,g2,t))},${Math.round(lerp(b1,b2,t))},${lerp(a1,a2,t)})`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOOP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function gameLoop(){
  if(state==='paused'){draw();frameId=requestAnimationFrame(gameLoop);return;}
  update();draw();frameId=requestAnimationFrame(gameLoop);
}
document.getElementById('h-hi').textContent=hiScore;
draw();
</script>
</body>
</html>
